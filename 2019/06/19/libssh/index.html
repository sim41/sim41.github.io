<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="libssh库简介今天依旧是一篇旧文，还是ssh相关。ssh相关的开发大多是基于libssh库。本文关于libssh库的介绍，基本上也是对文档的翻译，时隔较旧，如有纰漏欢迎指正。">
<meta name="keywords" content="ssh">
<meta property="og:type" content="article">
<meta property="og:title" content="libssh">
<meta property="og:url" content="https://sim41.com/2019/06/19/libssh/index.html">
<meta property="og:site_name" content="Simest&#39;s Blog">
<meta property="og:description" content="libssh库简介今天依旧是一篇旧文，还是ssh相关。ssh相关的开发大多是基于libssh库。本文关于libssh库的介绍，基本上也是对文档的翻译，时隔较旧，如有纰漏欢迎指正。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-06-19T09:35:05.776Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="libssh">
<meta name="twitter:description" content="libssh库简介今天依旧是一篇旧文，还是ssh相关。ssh相关的开发大多是基于libssh库。本文关于libssh库的介绍，基本上也是对文档的翻译，时隔较旧，如有纰漏欢迎指正。">





  
  
  <link rel="canonical" href="https://sim41.com/2019/06/19/libssh/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>libssh | Simest's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Simest's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Life and code</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sim41.com/2019/06/19/libssh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Simest">
      <meta itemprop="description" content="Focus on database/Linux/C/go/docker">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simest's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">libssh

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-19 16:29:34 / 修改时间：17:35:05" itemprop="dateCreated datePublished" datetime="2019-06-19T16:29:34+08:00">2019-06-19</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/协议/" itemprop="url" rel="index"><span itemprop="name">协议</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/协议/ssh/" itemprop="url" rel="index"><span itemprop="name">ssh</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="libssh库简介"><a href="#libssh库简介" class="headerlink" title="libssh库简介"></a>libssh库简介</h1><p>今天依旧是一篇旧文，还是ssh相关。ssh相关的开发大多是基于libssh库。本文关于libssh库的介绍，基本上也是对文档的翻译，时隔较旧，如有纰漏欢迎指正。</p>
<a id="more"></a>

<h2 id="Chapter-1-SSH会话示例"><a href="#Chapter-1-SSH会话示例" class="headerlink" title="Chapter 1:SSH会话示例"></a>Chapter 1:SSH会话示例</h2><h3 id="创建会话并设置选项"><a href="#创建会话并设置选项" class="headerlink" title="创建会话并设置选项"></a>创建会话并设置选项</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libssh/libssh.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ssh_session my_ssh_session = ssh_new();</span><br><span class="line">	<span class="keyword">if</span> (my_ssh_session == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	</span><br><span class="line">	ssh_free(my_ssh_session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ssh-new"><a href="#ssh-new" class="headerlink" title="ssh_new()"></a>ssh_new()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ssh_session <span class="title">ssh_new</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>返回一个ssh_session指针，错误时返回NULL</p>
<p>引用ssh_buffer_new()和ssh_set_blocking()</p>
<h4 id="ssh-buffer-new"><a href="#ssh-buffer-new" class="headerlink" title="ssh_buffer_new()"></a>ssh_buffer_new()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct ssh_buffer_struct * <span class="title">ssh_buffer_new</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>创建一个新的SSH缓冲区</p>
<p>返回新初始化的SSH缓冲区，错误时为NULL</p>
<h4 id="ssh-set-blocking"><a href="#ssh-set-blocking" class="headerlink" title="ssh_set_blocking()"></a>ssh_set_blocking()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ssh_set_blocking</span> <span class="params">(ssh_session session,<span class="keyword">int</span> blocking)</span></span></span><br></pre></td></tr></table></figure>

<p>将会话设置为阻塞/非阻塞模式</p>
<p>blocking 参数 0 设置为非阻塞模式</p>
<h4 id="ssh-free"><a href="#ssh-free" class="headerlink" title="ssh_free()"></a>ssh_free()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ssh_free</span><span class="params">(ssh_session session)</span></span></span><br></pre></td></tr></table></figure>

<p>释放已分配的SSH会话句柄</p>
<p>libssh遵循allocate-it-deallocate-it模式，使用ssh_new()分配，必须使用ssh_free()进行取消分配</p>
<h4 id="ssh-options-set"><a href="#ssh-options-set" class="headerlink" title="ssh_options_set()"></a>ssh_options_set()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_options_set</span><span class="params">(ssh_session session, <span class="keyword">enum</span> ssh_optinons_e type, <span class="keyword">const</span> <span class="keyword">void</span>* value)</span></span></span><br></pre></td></tr></table></figure>

<p>设置会话的选项</p>
<p>type：要设置的选项类型，常用的选项：</p>
<ul>
<li>SSH_OPTIONS_HOST:连接到的主机名或IP地址(const char*)</li>
<li>SSH_OPTIONS_PORT:连接到的端口(unsigned int)</li>
<li>SSH_OPTIONS_USER:想要连接的系统用户(const char*)</li>
<li>SSH_OPTIONS_LOG_VERBOSITY:打印的消息数量(int)</li>
</ul>
<p>其中SSH_OPTIONS_HOST是唯一的强制选项；端口号默认22；不使用SSH_OPTIONS_USER,则会使用当前账户的本地账用户名</p>
<h3 id="连接到服务器"><a href="#连接到服务器" class="headerlink" title="连接到服务器"></a>连接到服务器</h3><p>完成设置后。可使用ssh_connect()进行连接。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libssh/libssh.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ssh_session my_ssh_session;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">	my_ssh_session = ssh_new();</span><br><span class="line">	<span class="keyword">if</span> (my_ssh_session == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">	ssh_options_set(my_ssh_session,SSH_OPTIONS_HOST,<span class="string">"localhost"</span>)；</span><br><span class="line">	</span><br><span class="line">	rc = ssh_connect(my_ssh_session);</span><br><span class="line">	<span class="keyword">if</span> (rc!=SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"连接到本地主机错误：%s\n"</span>,ssh_get_error(my_ssh_session));</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ssh_disconnect(my_ssh_session);</span><br><span class="line">	ssh_free(my_ssh_session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ssh-connect"><a href="#ssh-connect" class="headerlink" title="ssh_connect()"></a>ssh_connect()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_connect</span><span class="params">(ssh_session session)</span></span></span><br></pre></td></tr></table></figure>

<p>连接到ssh服务器</p>
<p>成功时返回SSH_OK，错误时返回SSH_ERROR。若会话处于无阻塞模式，且必须要重连，返回SSH_AGAIN</p>
<h4 id="ssh-get-error"><a href="#ssh-get-error" class="headerlink" title="ssh_get_error()"></a>ssh_get_error()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">ssh_get_error</span><span class="params">(<span class="keyword">void</span>* error)</span></span></span><br></pre></td></tr></table></figure>

<p>error ssh_session 或者 ssh_bind</p>
<p>返回描述错误的static字符串</p>
<h4 id="ssh-disconnect"><a href="#ssh-disconnect" class="headerlink" title="ssh_disconnect()"></a>ssh_disconnect()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ssh_disconnect</span><span class="params">(ssh_session session)</span></span></span><br></pre></td></tr></table></figure>

<p>从一个会话断开连接（服务器或客户端）；该会话之后可以在新的会话中重新开始使用。</p>
<p>与ssh_connect()组合使用</p>
<h3 id="验证服务器"><a href="#验证服务器" class="headerlink" title="验证服务器"></a>验证服务器</h3><p>连接完成后，必须检查刚刚连接的服务器是否一致且安全可用，有两种方式实现：</p>
<ol>
<li><strong>（推荐）</strong>使用ssh_is_server_known()函数。该函数将查看已知的主机文件(UNIX中的~/.ssh/known_hosts)，查找服务器主机名的模式，并确认该主机是否存在列表中</li>
<li>使用ssh_get_pubkey_hash()函数。使用该函数获取二进制版本的公钥hash值，通过本地数据库检查此公钥是否已知且安全</li>
</ol>
<h4 id="ssh-is-server-known"><a href="#ssh-is-server-known" class="headerlink" title="ssh_is_server_known()"></a>ssh_is_server_known()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_is_server_known</span><span class="params">(ssh_session session)</span></span></span><br></pre></td></tr></table></figure>

<p>返回一个状态码</p>
<h4 id="ssh-get-pubkey-hash"><a href="#ssh-get-pubkey-hash" class="headerlink" title="ssh_get_pubkey_hash()"></a>ssh_get_pubkey_hash()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_get_pubkey_hash</span><span class="params">(ssh_session session, <span class="keyword">unsigned</span> <span class="keyword">char</span>** hash)</span></span></span><br></pre></td></tr></table></figure>

<p>推荐使用ssh_get_publickey_hash()</p>
<p>如果时第一次使用远程主机，可以询问用户是否信任主机。如认为主机是有效的并且值得添加到已知主机文件中，可以使用ssh_write_knownhost()将其注册到已知主机文件中，或使用自己的数据库。</p>
<h4 id="ssh-write-knownhost"><a href="#ssh-write-knownhost" class="headerlink" title="ssh_write_knownhost()"></a>ssh_write_knownhost()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_write_knownhost</span><span class="params">(ssh_session session)</span></span></span><br></pre></td></tr></table></figure>

<p>写入成功返回SSH_OK,失败则返回SSH_ERROR</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;error.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">verify_knownhost</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> state,hlen;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *hash = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">char</span> *hexa;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">	state = ssh_is_server_known(session);<span class="comment">//是否识别远程主机</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//获取远程主机的公钥hash</span></span><br><span class="line">	hlen = ssh_get_pubkey_hash(session,&amp;hash);</span><br><span class="line">	<span class="keyword">if</span> (hlen&lt;<span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//根据状态返回报错信息或进行下一步</span></span><br><span class="line">	<span class="keyword">switch</span>(state)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> SSH_SERVER_KNOWN_OK:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SSH_SERVER_KNOWN_CHANGED:</span><br><span class="line">			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Host key for server changed:it is now:\n"</span>)；</span><br><span class="line">			ssh_print_hexa（<span class="string">"Public key hash"</span>,hash,hlen);</span><br><span class="line">			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"For security reasons, connection will be stopped\n"</span>);</span><br><span class="line">			<span class="built_in">free</span>(hash);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SSH_SERVER_FOUND_OTHER:</span><br><span class="line">			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"The host key for this server was not found but an other type of key exists.\n"</span>);</span><br><span class="line">  		    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"An attacker might change the default server key to confuse your client into thinking the key does not exist\n"</span>);</span><br><span class="line">            <span class="built_in">free</span>(hash);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SSH_SERVER_FILE_NOT_FOUND:</span><br><span class="line">  			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not find known host file.\n"</span>);</span><br><span class="line">  			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"If you accept the host key here, the file will be automatically created.\n"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SSH_SERVER_NOT_KNOWN:</span><br><span class="line">  			hexa = ssh_get_hexa(hash, hlen);</span><br><span class="line">  			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"The server is unknown. Do you trust the host key?\n"</span>);</span><br><span class="line">  			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Public key hash: %s\n"</span>, hexa);</span><br><span class="line">  			<span class="built_in">free</span>(hexa);</span><br><span class="line">  			<span class="keyword">if</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), <span class="built_in">stdin</span>) == <span class="literal">NULL</span>)</span><br><span class="line">  			&#123;</span><br><span class="line">    			<span class="built_in">free</span>(hash);</span><br><span class="line">    			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  			&#125;</span><br><span class="line">  			<span class="keyword">if</span> (strncasecmp(buf, <span class="string">"yes"</span>, <span class="number">3</span>) != <span class="number">0</span>)</span><br><span class="line">  			&#123;</span><br><span class="line">	        <span class="built_in">free</span>(hash);</span><br><span class="line">	        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	      	&#125;</span><br><span class="line">	      	<span class="keyword">if</span> (ssh_write_knownhost(session) &lt; <span class="number">0</span>)</span><br><span class="line">	      	&#123;</span><br><span class="line">	        	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error %s\n"</span>, strerror(errno));</span><br><span class="line">	        	<span class="built_in">free</span>(hash);</span><br><span class="line">	        	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	      	&#125;</span><br><span class="line">	      	<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SSH_SERVER_ERROR:</span><br><span class="line">			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error %s\n"</span>,ssh_get_error?(session));</span><br><span class="line">			<span class="built_in">free</span>(hash);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(hash);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ssh-get-error-code"><a href="#ssh-get-error-code" class="headerlink" title="ssh_get_error_code()"></a>ssh_get_error_code()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_get_error_code</span><span class="params">(<span class="keyword">void</span>* error)</span></span></span><br></pre></td></tr></table></figure>

<p>用于接受最后一个错误的错误代码</p>
<p>返回一个错误代码，对应不同错误状态</p>
<h3 id="验证用户"><a href="#验证用户" class="headerlink" title="验证用户"></a>验证用户</h3><p>在用户验证服务器是安全可用的远程主机后，下一步是服务器授权用户，使已认证的用户能够访问资源。</p>
<p>libssh支持的认证方法：</p>
<ul>
<li>无认证</li>
<li>密码方法</li>
<li>键盘交互方式：服务器向用户发出几个挑战，用户必须正确回答问题。志告方式使通过密码本验证成为可能</li>
<li>公钥方法</li>
</ul>
<p>这些认证方式可以结合使用。</p>
<p>一个使用密码进行身份验证的实例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libssh/libssh.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ssh_session my_ssh_session;</span><br><span class="line">	<span class="keyword">int</span>* rc;</span><br><span class="line">	<span class="keyword">char</span>* password;</span><br><span class="line"></span><br><span class="line">	my_ssh_session = ssh_new();</span><br><span class="line">	<span class="keyword">if</span> (my_ssh_session == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	ssh_options_set(my_ssh_session,SSH_OPTIONS_HOST,<span class="string">"localhost"</span>);</span><br><span class="line"></span><br><span class="line">	rc = ssh_connect(my_ssh_session);</span><br><span class="line">	<span class="keyword">if</span> (rc!=SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error connecting to localhost:%s\n"</span>,ssh_get_error(my_ssh_session));</span><br><span class="line">		ssh_free(my_ssh_session);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (verify_knowhost(my_ssh_session)&lt;<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ssh_disconnect(my_ssh_session);</span><br><span class="line">		ssh_free(my_ssh_session);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	password = getpass(<span class="string">"Password:"</span>);</span><br><span class="line">	rc = ssh_userauth_password(my_ssh_session,<span class="literal">NULL</span>,password);</span><br><span class="line">	<span class="keyword">if</span>(rc!=SSH_AUTH_SUCCESS)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error authenticating with password:%s\n"</span>,ssh_get_error(my_ssh_session));</span><br><span class="line">		ssh_disconnect(my_ssh_session);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">  ssh_disconnect(my_ssh_session);</span><br><span class="line">	ssh_free(my_ssh_connect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><p>在双方进行验证后，下一步可以利用SSH协议进行操作，执行远程命令，开启远程终端，交换文件，转发端口；等等。</p>
<p>执行远程命令的示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">show_remote_processes</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ssh_channel channel'</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	<span class="keyword">char</span> buffer[<span class="number">256</span>];</span><br><span class="line">	<span class="keyword">int</span> nbytes;</span><br><span class="line">	</span><br><span class="line">	channel = ssh_channel_new(session);</span><br><span class="line">	<span class="keyword">if</span> (channel == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	</span><br><span class="line">	rc = ssh_channel_open_session(channel);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		ssh_channel_close(channel);</span><br><span class="line">		ssh_channel_free(channel);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nbytes = ssh_channel_read(channel,buffer,<span class="keyword">sizeof</span>(buffer),<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">while</span>(nbytes &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (write(<span class="number">1</span>,buffer,nbytes)!= (<span class="keyword">unsigned</span> <span class="keyword">int</span>)nbytes)</span><br><span class="line">		&#123;</span><br><span class="line">			ssh_channel_close(channel);</span><br><span class="line">			ssh_channel_free(channel);</span><br><span class="line">			<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">		&#125;</span><br><span class="line">		nbytes = ssh_channel_read(channel,buffer,<span class="keyword">sizeof</span>(buffer),<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(nbytes &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ssh_channel_close(channel);</span><br><span class="line">		ssh_channel_free(channel);</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ssh_channel_send_eof(channel);</span><br><span class="line">	ssh_channel_close(channel);</span><br><span class="line">	ssh_channel_free(channel);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Chapter-2-用户验证相关"><a href="#Chapter-2-用户验证相关" class="headerlink" title="Chapter 2:用户验证相关"></a>Chapter 2:用户验证相关</h2><p>公钥，密码，挑战应答模式（键盘交互），无验证</p>
<h3 id="公钥验证方法"><a href="#公钥验证方法" class="headerlink" title="公钥验证方法"></a>公钥验证方法</h3><p>libssh与openssh公钥和私钥完全兼容，可以使用libssh提供的自动公钥验证方法，也可以使用公钥函数进行自定义。</p>
<h4 id="验证流程"><a href="#验证流程" class="headerlink" title="验证流程"></a>验证流程</h4><ol>
<li>扫描本地包含公钥的文件列表，每个密钥都发送到SSH服务器，直到服务器确认一个密钥（服务器已知的可以认证用户的密钥）。</li>
<li>检索此密钥的私钥并发送证明自己知道该私钥的消息。</li>
</ol>
<p>使用ssh_userauth_publickey_auto()函数进行验证</p>
<h4 id="ssh-userauth-publickey-auto"><a href="#ssh-userauth-publickey-auto" class="headerlink" title="ssh_userauth_publickey_auto()"></a>ssh_userauth_publickey_auto()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_userauth_publickey_auto</span><span class="params">(ssh_session session,<span class="keyword">const</span> <span class="keyword">char</span>* username,<span class="keyword">const</span> <span class="keyword">char</span>* passphrase)</span></span></span><br></pre></td></tr></table></figure>

<p>尝试自动使用公钥或无验证方式进行验证</p>
<p>参数：</p>
<ul>
<li>session SSH会话</li>
<li>username 用户名，应该为NULL</li>
<li>passphrase 密码，用于解锁私钥，如果不使用密码或需要询问用户时用NULL</li>
</ul>
<p>返回值：</p>
<ul>
<li>SSH_AUTH_ERROR:发生严重错误</li>
<li>SSH_AUTH_DENIED:服务器不接受该公钥验证，尝试另一个公钥或其他方法</li>
<li>SSH_AUTH_PARTIAL:已经被部分认证（多验证方式存在），仍需要其他验证方法</li>
<li>SSH_AUTH_SUCCESS:公钥通过验证，可以使用ssh_userauth_publickey()</li>
<li>SSH_AUTH_AGAIN:非阻塞模式下，须稍后再重新调用</li>
</ul>
<h4 id="ssh-userauth-publickey"><a href="#ssh-userauth-publickey" class="headerlink" title="ssh_userauth_publickey()"></a>ssh_userauth_publickey()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_userauth_publickey</span><span class="params">(ssh_session session,<span class="keyword">const</span> <span class="keyword">char</span>* username,<span class="keyword">const</span> ssh_key privkey)</span></span></span><br></pre></td></tr></table></figure>

<p>使用公钥/私钥或证书进行验证，与用户的私钥进行身份验证匹配</p>
<p>大多数服务器实现不允许在认证过程中更改用户名，只有在连接到服务器之前才应该使用ssh_options_set()来设置用户名，username参数应该设置为NULL</p>
<h4 id="使用自己的公钥进行身份验证"><a href="#使用自己的公钥进行身份验证" class="headerlink" title="使用自己的公钥进行身份验证"></a>使用自己的公钥进行身份验证</h4><p>步骤：</p>
<ul>
<li>使用ssh_pki_import_pobkey_file()检索公钥</li>
<li>使用ssh_userauth_try_publickey()将公钥提供给SSH服务器。如果返回值为SSH_AUTH_SUCCESS，则SSH服务器接受使用公钥进行身份验证，则进行下一步</li>
<li>使用ssh_userauth_publickey()与私钥进行身份验证</li>
<li>最后使用ssh_key_free()清理内存</li>
</ul>
<h4 id="ssh-pki-import-pubkey-file"><a href="#ssh-pki-import-pubkey-file" class="headerlink" title="ssh_pki_import_pubkey_file()"></a>ssh_pki_import_pubkey_file()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_pki_import_pubkey_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* filename,ssh_key* pkey)</span></span></span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li>filename 公钥文件的地址</li>
<li>pkey 存储公钥分配的指针，需要使用ssh_key_free()释放内存</li>
</ul>
<p>返回值：</p>
<p>成功时返回SSH_OK；文件不存在或者权限被拒绝返回SSH_EOF；其他返回SSH_ERROR</p>
<h4 id="ssh-userauth-try-publickey"><a href="#ssh-userauth-try-publickey" class="headerlink" title="ssh_userauth_try_publickey()"></a>ssh_userauth_try_publickey()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_userauth_try_publickey</span><span class="params">(ssh_session session,<span class="keyword">const</span> <span class="keyword">char</span>* username,<span class="keyword">const</span> ssh_key pubkey)</span></span></span><br></pre></td></tr></table></figure>

<p>尝试使用给定的公钥进行身份验证</p>
<h4 id="ssh-pki-import-privkey-file"><a href="#ssh-pki-import-privkey-file" class="headerlink" title="ssh_pki_import_privkey_file()"></a>ssh_pki_import_privkey_file()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_pki_import_privkey_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* filename,<span class="keyword">const</span> <span class="keyword">char</span>* passphrase,ssh_auth_callback auth_fn,<span class="keyword">void</span>* auth_data,ssh_key* pkey)</span></span></span><br></pre></td></tr></table></figure>

<p>从文件中个导入密钥</p>
<p>参数：</p>
<ul>
<li>filename:私钥名称</li>
<li>passphrase:私钥的解密密钥。未加密或未知设为NULL</li>
<li>auth_fn:希望使用的验证函数或为NULL</li>
<li>auth_data:传递给验证函数的私有数据</li>
<li>Pkey:分配给存储ssh_key的指针，需要使用ssh_key_free()释放</li>
</ul>
<p>返回值：</p>
<p>成功时返回SSH_OK；文件不存在或者权限被拒绝返回SSH_EOF；其他返回SSH_ERROR</p>
<h4 id="ssh-key-free"><a href="#ssh-key-free" class="headerlink" title="ssh_key_free()"></a>ssh_key_free()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ssh_key_free</span><span class="params">(ssh_key key)</span></span></span><br></pre></td></tr></table></figure>

<p>释放一个SSH key</p>
<h4 id="一个示例"><a href="#一个示例" class="headerlink" title="一个示例"></a>一个示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">authenticate_pubkey</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	</span><br><span class="line">	rc = ssh_userauth_publickey_auto(session <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rc = SSH_AUTH_ERROR)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Authentication failed: %s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> SSH_AUTH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="密码验证"><a href="#密码验证" class="headerlink" title="密码验证"></a>密码验证</h3><p>使用ssh_userauth_password()进行密码身份验证。若密码通过验证，返回SSH_AUTH_SUCCESS。需要询问密码并进行安全分配管理。</p>
<p>如果服务器反馈密码错误，但仍可以使用openssh的客户端进行身份验证，可能是因为openssh只接受键盘交互形式的验证。切换到键盘交互模式，或尝试在SSH服务器上配置纯文本密码。</p>
<h4 id="ssh-userauth-password"><a href="#ssh-userauth-password" class="headerlink" title="ssh_userauth_password()"></a>ssh_userauth_password()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_userauth_password</span><span class="params">(ssh_session session,<span class="keyword">const</span> <span class="keyword">char</span>* username,<span class="keyword">const</span> <span class="keyword">char</span>* password)</span></span></span><br></pre></td></tr></table></figure>

<p>尝试使用密码进行验证；该方法通常在SSHv2服务器上被禁止，应当使用键盘交互模式进行验证。</p>
<p>password值必须用UTF-8进行编码，如何与解释密码，并与密码数据库进行验证由服务器决定。</p>
<h3 id="键盘交互认证方法"><a href="#键盘交互认证方法" class="headerlink" title="键盘交互认证方法"></a>键盘交互认证方法</h3><p>服务器提出challenge，一个或多个用户必须回答的问题，直到服务器接受认证</p>
<h4 id="ssh-userauth-kbdint"><a href="#ssh-userauth-kbdint" class="headerlink" title="ssh_userauth_kbdint()"></a>ssh_userauth_kbdint()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_userauth_kbdint</span><span class="params">(ssh_session session,<span class="keyword">const</span> <span class="keyword">char</span>* user,<span class="keyword">const</span> <span class="keyword">char</span>* submethods)</span></span></span><br></pre></td></tr></table></figure>

<p>尝试通过键盘交互模式进行验证。</p>
<p>参数：</p>
<ul>
<li>session：将要使用的ssh会话</li>
<li>user：需要验证的用户名，定义为NULL，有ssh_option_set_username()修改用户名，中途不能修改</li>
<li>submethods：设定为NULL</li>
</ul>
<p>返回：</p>
<ul>
<li>SSH_AUTH_ERROR:发生严重错误</li>
<li>SSH_AUTH_DENIED:认证失败：使用另一种方法</li>
<li>SSH_AUTH_PARTIAL:部分认证成功，仍需要其他方法的认证</li>
<li>SSH_AUTH_SUCCESS:认证成功</li>
<li>SSH_AUTH_INFO:服务器询问了一些问题，使用ssh_userauth_kbdint_getnprompts()</li>
<li>SSH_AUTH_AGAIN:在无阻塞模式中，需要之后再重新访问</li>
</ul>
<h4 id="ssh-userauth-kbdint-getnprompts"><a href="#ssh-userauth-kbdint-getnprompts" class="headerlink" title="ssh_userauth_kbdint_getnprompts()"></a>ssh_userauth_kbdint_getnprompts()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_userauth_kbdint_getprompts</span><span class="params">(ssh_session session)</span></span></span><br></pre></td></tr></table></figure>

<p>获取服务器提供的提示(问题)数量</p>
<p>返回： 提示的数量</p>
<h4 id="ssh-userauth-kbdint-getname"><a href="#ssh-userauth-kbdint-getname" class="headerlink" title="ssh_userauth_kbdint_getname()"></a>ssh_userauth_kbdint_getname()</h4><p>定义：</p>
<pre><code>const char* ssh_userauth_kbdint_getname(ssh_session session)</code></pre><p>获得消息块的名称。调用ssh_userauth_kbdint()并收到了SSH_AUTH_INFO返回码，调用该函数检索远程主机发送的键盘交互认证问题的信息。</p>
<p>返回：消息快的名称，不要释放该指针</p>
<h4 id="ssh-userauth-kbdint-getinstruction"><a href="#ssh-userauth-kbdint-getinstruction" class="headerlink" title="ssh_userauth_kbdint_getinstruction()"></a>ssh_userauth_kbdint_getinstruction()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">ssh_userauth_kbdint_getinstruction</span><span class="params">(ssh_session session)</span></span></span><br></pre></td></tr></table></figure>

<p>获取消息块的指令</p>
<p>返回：消息块的指令</p>
<h4 id="ssh-userauth-kbdint-getprompt"><a href="#ssh-userauth-kbdint-getprompt" class="headerlink" title="ssh_userauth_kbdint_getprompt()"></a>ssh_userauth_kbdint_getprompt()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">ssh_userauth_kbdint_getprompt</span><span class="params">(ssh_session session,<span class="keyword">unsigned</span> <span class="keyword">int</span> i,<span class="keyword">char</span>* echo)</span></span></span><br></pre></td></tr></table></figure>

<p>从消息块获取提示</p>
<p>参数：</p>
<ul>
<li>session 使用的ssh会话</li>
<li>i 当前提示的索引</li>
<li>echo 可选项，获取一个布尔值，用于设定用户输入应该被回显或隐藏，密码通常设定为隐藏</li>
</ul>
<p>返回：指向提示符的指针，不要释放该指针</p>
<h4 id="ssh-user-kbdint-setanswer"><a href="#ssh-user-kbdint-setanswer" class="headerlink" title="ssh_user_kbdint_setanswer()"></a>ssh_user_kbdint_setanswer()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_userauth_kbdint_setanswer</span><span class="params">(ssh_session session,<span class="keyword">unsigned</span> <span class="keyword">int</span> i,<span class="keyword">const</span> <span class="keyword">char</span>* answer)</span></span></span><br></pre></td></tr></table></figure>

<p>回复来自消息块的问题的答案</p>
<p>参数：</p>
<ul>
<li>session 当前会话</li>
<li>i 当前提示的索引编号</li>
<li>answer 给服务器的答案，必须为UTF-8格式的编码。如何解释并使用该值进行验证取决于服务器，但如果使用其他格式编码答案，则必须先转换为UTF-8</li>
</ul>
<p>返回：成功时返回0，错误时返回值&lt;0</p>
<h4 id="认证过程"><a href="#认证过程" class="headerlink" title="认证过程"></a>认证过程</h4><ol>
<li>调用ssh_userauth_kbdint()函数并存储答案</li>
<li>如果收到的返回是SSH_AUTH_INFO，则说明服务器发送了几个问题，询问用户，使用ssh_userauth_kbdint_getnprompts(),ssh_userauth_kbdint_getname(),ssh_userauth_kbdint_getinstruction()和ssh_userauth_kbdint_getprompt()检索问题</li>
<li>使用ssh_userauth_kbdint_setanswer()为挑战中的每个问题设置答案</li>
<li>再次调用ssh_userauth_kbdint()，直到这些函数返回的内容不是SSH_AUTH_INFO</li>
</ol>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为当前会话进行键盘交互方式的认证</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">authenticate_kbdint</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;<span class="comment">//状态码</span></span><br><span class="line">	</span><br><span class="line">	rc  = ssh_userauth_kbdint(session,<span class="literal">NULL</span>,<span class="literal">NULL</span>)</span><br><span class="line">	<span class="keyword">while</span>(rc == SSH_AUTH_INFO)<span class="comment">//调用直到返回值不是SSH_AUTH_INFO</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span> *name,*instruction;</span><br><span class="line">		<span class="keyword">int</span> nprompts,iprompt;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//检索问题，获取问题的名称，指令，提示</span></span><br><span class="line">		name = ssh_userauth_kbdint_getname(session);</span><br><span class="line">		instruction = ssh_userauth_kbdint_getinstruction(session);</span><br><span class="line">		nprompts = ssh_userauth_kbdint_getnprompts(session);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strlen</span>(name)&gt;<span class="number">0</span>)</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"%s\n"</span>,name);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strlen</span>(instruction)&gt;<span class="number">0</span>)</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"%s\n"</span>,instruction);</span><br><span class="line">		<span class="keyword">for</span> (iprompt = <span class="number">0</span>;iprompt &lt; nmprompts;iprompt++)<span class="comment">//循环获取所有的提示，并获取用户的答案</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">char</span> *prompt;</span><br><span class="line">			<span class="keyword">char</span> echo;</span><br><span class="line">		</span><br><span class="line">			prompt = ssh_userauth_kbdint_getprompt(session,iprompt,&amp;echo);<span class="comment">//检索提示，将内容赋给prompt</span></span><br><span class="line">			<span class="keyword">if</span> (echo)<span class="comment">//如果设定为真，显示用户回显</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">char</span> buffer[<span class="number">128</span>], *ptr;</span><br><span class="line"></span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"%s"</span>,prompt);</span><br><span class="line">				<span class="keyword">if</span> (fgets(buffer,<span class="keyword">sizeof</span>(buffer),<span class="built_in">stdin</span>)==<span class="literal">NULL</span>)<span class="comment">//用户未能回答问题，则验证失败</span></span><br><span class="line">					<span class="keyword">return</span> SSH_AUTH_ERROR;</span><br><span class="line">				buffer[<span class="keyword">sizeof</span>(buffer)<span class="number">-1</span>] = <span class="string">'\0'</span>;<span class="comment">//将缓存中的最后一位置为标志'\0'</span></span><br><span class="line">				<span class="keyword">if</span> ((ptr = <span class="built_in">strchr</span>(buffer,<span class="string">'\n'</span>))!=<span class="literal">NULL</span>)</span><br><span class="line">					*ptr = <span class="string">'\0'</span>;</span><br><span class="line">				<span class="keyword">if</span> (ssh_userauth_kbdint_setanswer(session,ipromot,buffer)&lt;<span class="number">0</span>)<span class="comment">//如果服务器验证未通过，返回失败</span></span><br><span class="line">					<span class="keyword">return</span> SSH_AUTH_ERROR;</span><br><span class="line">				<span class="built_in">memset</span>(buffer,<span class="number">0</span>,<span class="built_in">strlen</span>(buffer));<span class="comment">//将缓存区置空</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span><span class="comment">//设定为隐藏模式，以密码形式读取</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">char</span> *ptr;</span><br><span class="line"></span><br><span class="line">				ptr = getpass(prompt);</span><br><span class="line">				<span class="keyword">if</span> (ssh_userauth_kbdint_setanswer(session,iprompt,ptr)&lt;<span class="number">0</span>)</span><br><span class="line">					<span class="keyword">return</span> SSH_AUTH_ERROR;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		rc = ssh_userauth_kbdint(session,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用“无验证”模式"><a href="#使用“无验证”模式" class="headerlink" title="使用“无验证”模式"></a>使用“无验证”模式</h3><p>无验证模式主要目的是在没有任何凭证的情况下进行认证（除非确实要授权匿名访问权限，不要使用该方式）。</p>
<p>如果该账号没有密码，且服务器配置为允许通过，则ssh_userauth_none()可能回复SSH_AUTH_SUCCESS</p>
<h4 id="ssh-userauth-none"><a href="#ssh-userauth-none" class="headerlink" title="ssh_userauth_none()"></a>ssh_userauth_none()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_userauth_none</span><span class="params">(ssh_session session,<span class="keyword">const</span> <span class="keyword">char</span>* username)</span></span></span><br></pre></td></tr></table></figure>

<h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">authenticate_kbdint</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	</span><br><span class="line">	rc = ssh_userauth_none(session,<span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取支持的身份验证列表"><a href="#获取支持的身份验证列表" class="headerlink" title="获取支持的身份验证列表"></a>获取支持的身份验证列表</h3><p>如果不选择指定某种验证方法，可以让服务器展示可以是使用的验证方法</p>
<p>使用ssh_userauth_list()函数获取可用的身份验证方法以及如何使用</p>
<h4 id="ssh-userauth-list"><a href="#ssh-userauth-list" class="headerlink" title="ssh_userauth_list()"></a>ssh_userauth_list()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_userauth_list</span><span class="params">(ssh_session session,<span class="keyword">const</span> <span class="keyword">char</span>* username)</span></span></span><br></pre></td></tr></table></figure>

<p>获取服务器可使用的验证方法，调用该函数前需要调用ssh_userauth_none()</p>
<p>返回：</p>
<ul>
<li>SSH_AUTH_METHOD_PASSWORD</li>
<li>SSH_AUTH_METHOD_PUBLICKEY</li>
<li>SSH_AUTH_METHOD_HOSTBASED</li>
<li>SSH_AUTH_METHOD_INTERACTIVE</li>
</ul>
<h3 id="获取横幅"><a href="#获取横幅" class="headerlink" title="获取横幅"></a>获取横幅</h3><p>SSH服务器可能会发送一个横幅，一般为免责声明等内容用，使用ssh_get_issue_banner()检索横幅，显示给用户</p>
<h4 id="ssh-get-issue-banner"><a href="#ssh-get-issue-banner" class="headerlink" title="ssh_get_issue_banner()"></a>ssh_get_issue_banner()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">ssh_get_issue_banner</span><span class="params">(ssh_session session)</span></span></span><br></pre></td></tr></table></figure>

<p>返回分配给横幅的字符串指针，出错时返回NULL</p>
<h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">display_banner</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	<span class="keyword">char</span> *banner;</span><br><span class="line"></span><br><span class="line">	rc = ssh_userauth_none(session,<span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (rc = SSH_AUTH_ERROR)</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	banner = ssh_get_issue_banner(session);</span><br><span class="line">	<span class="keyword">if</span> (banner)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%s\n"</span>,banner);</span><br><span class="line">		<span class="built_in">free</span>(banner);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Chapter-3-开启远程终端"><a href="#Chapter-3-开启远程终端" class="headerlink" title="Chapter 3:开启远程终端"></a>Chapter 3:开启远程终端</h2><p>一个SSH连接可以有多个信道共享。一个信道可以用于多种用途。可以创建信道，用于开启远程终端，在远程计算机上启动命令解释程序。</p>
<h3 id="打开和关闭信道"><a href="#打开和关闭信道" class="headerlink" title="打开和关闭信道"></a>打开和关闭信道</h3><p>使用ssh_channel_new()函数创建一个信道，创建好之后，使用ssh_channel_open_session()打开一个SSH会话。不需要该信道时，使用ssh_channel_close()发送文件结束符(eof)，此时可以通过ssh_channel_free()销毁信道</p>
<h4 id="ssh-channel-new"><a href="#ssh-channel-new" class="headerlink" title="ssh_channel_new()"></a>ssh_channel_new()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ssh_channel <span class="title">ssh_channel_new</span><span class="params">(ssh_session session)</span></span></span><br></pre></td></tr></table></figure>

<p>分配一个新的信道</p>
<p>返回：指向新分配的信道的指针，错误时返回NULL</p>
<h4 id="ssh-channel-open-session"><a href="#ssh-channel-open-session" class="headerlink" title="ssh_channel_open_session()"></a>ssh_channel_open_session()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_channel_open_session</span><span class="params">(ssh_channel channel)</span></span></span><br></pre></td></tr></table></figure>

<p>参数：channel：分配好的信道</p>
<p>返回：</p>
<ul>
<li>SSH_OK 成功时返回</li>
<li>SSH_ERROR 错误时返回</li>
<li>SSH_AGAIN 无阻塞模式下，需要等待重新调用</li>
</ul>
<h4 id="ssh-channel-close"><a href="#ssh-channel-close" class="headerlink" title="ssh_channel_close()"></a>ssh_channel_close()</h4><p>关闭一个信道，发送文件结束符(EOF)并关闭信道。关闭后无法恢复无法去要发送或处于缓冲区中的数据</p>
<p>返回：成功返回SSH_OK，失败返回SSH_ERROR</p>
<h4 id="ssh-channel-free"><a href="#ssh-channel-free" class="headerlink" title="ssh_channel_free()"></a>ssh_channel_free()</h4><p>关闭并释放一个信道</p>
<p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ssh_channel_free</span><span class="params">(ssh_channel channel)</span></span></span><br></pre></td></tr></table></figure>

<p>调用函数后该信道上的所有数据均会丢失</p>
<h4 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shell_session</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ssh_channel channel;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	</span><br><span class="line">	channel = ssh_channel_new(session);</span><br><span class="line">	<span class="keyword">if</span> (channel == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">  </span><br><span class="line">	rc = ssh_channel_open_session(channel);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		ssh_channel_free(channel);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line">  		</span><br><span class="line">	ssh_channel_close(channel);</span><br><span class="line">	ssh_channel_send_eof(channel);</span><br><span class="line">	ssh_channel_free(channel);</span><br><span class="line">  		</span><br><span class="line">	<span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="交互会话与非交互会话"><a href="#交互会话与非交互会话" class="headerlink" title="交互会话与非交互会话"></a>交互会话与非交互会话</h3><p>如果需要一个接一个地键入命令，则认为是交互模式的；如果没有附加终端，类似于后台执行命令，是为为交互式的shell.</p>
<p>如果使用交互式shell。需要在远程终端创建一个伪终端，通过ssh_channel_request_pty()请求pty，然后用ssh_channel_change_pty_size()定义其维度(行数和列数）</p>
<p>无论使用交互会话还是非交互会话，都需要使用ssh_channel_request_shell()请求一个shell</p>
<h4 id="ssh-channel-request-pty"><a href="#ssh-channel-request-pty" class="headerlink" title="ssh_channel_request_pty()"></a>ssh_channel_request_pty()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_channel_request_pty</span><span class="params">(ssh_channel channel)</span></span></span><br></pre></td></tr></table></figure>

<p>请求一个伪终端PTY</p>
<p>返回：成功时返回SSH_OK，失败时返回SSH_ERROR,在非阻塞模式下如果需要重新调用返回SSH_AGAIN</p>
<h4 id="ssh-channel-change-pty-size"><a href="#ssh-channel-change-pty-size" class="headerlink" title="ssh_channel_change_pty_size()"></a>ssh_channel_change_pty_size()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_channel_change_pty_size</span><span class="params">(ssh_channel channel,<span class="keyword">int</span> cols,<span class="keyword">int</span> rows)</span></span></span><br></pre></td></tr></table></figure>

<p>改变远程终端的大小</p>
<p>参数：</p>
<ul>
<li>channel 使用的信道</li>
<li>cols 分配的列数</li>
<li>rows 分配的行数</li>
</ul>
<p>返回：成功时返回SSH_OK，失败时返回SSH_ERROR</p>
<blockquote>
<p>warning：</p>
</blockquote>
<blockquote>
<p>如果不确定使用相同信道/会话的其他libssh函数是否在同一时间运行(不是100%线程安全)，则不要从信号处理程序调用该函数</p>
</blockquote>
<h4 id="ssh-channel-request-shell"><a href="#ssh-channel-request-shell" class="headerlink" title="ssh_channel_request_shell()"></a>ssh_channel_request_shell()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_channel_request_shell</span><span class="params">(ssh_channel channel)</span></span></span><br></pre></td></tr></table></figure>

<p>请求一个shell</p>
<p>返回：成功时返回SSH_OK，失败时返回SSH_ERROR,在非阻塞模式下如果需要重新调用返回SSH_AGAIN</p>
<h4 id="示例-4"><a href="#示例-4" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">interactive_shell_session</span><span class="params">(ssh_channel channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">	rc = ssh_channel_request_pty(channel);</span><br><span class="line">	<span class="keyword">if</span> (rc!=SSH_OK) <span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	rc = ssh_channel_change_pty_size(channel,<span class="number">80</span>,<span class="number">24</span>);</span><br><span class="line">	<span class="keyword">if</span> (rc!=SSH_OK) <span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	rc = ssh_channel_request_shell(channel);</span><br><span class="line">	<span class="keyword">if</span> (rc!=SSH_OK) <span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="显示远程计算机发送的数据"><a href="#显示远程计算机发送的数据" class="headerlink" title="显示远程计算机发送的数据"></a>显示远程计算机发送的数据</h3><p>在程序中通常要接受来自远程终端的数据，需要进行分析，记录或显示</p>
<p>使用ssh_channel_read()和ssh_channel_read_nonblocking()从信道中读取数据</p>
<h4 id="ssh-channel-read"><a href="#ssh-channel-read" class="headerlink" title="ssh_channel_read()"></a>ssh_channel_read()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_channel_read</span><span class="params">(ssh_channel channel,<span class="keyword">void</span>* dest,<span class="keyword">uint32_t</span> count,<span class="keyword">int</span> is_stderr)</span></span></span><br></pre></td></tr></table></figure>

<p>从信道中读取数据</p>
<p>参数：</p>
<ul>
<li>channel 读取数据的来源信道</li>
<li>dest 接受数据的目标缓存区</li>
<li>count 读取的数据大小</li>
<li>is_stderr 标准错误流stderr中的内容的布尔值标志</li>
</ul>
<p>返回：</p>
<p>读取的数据的字节数，在错误时返回0或EOF标记或SSH_ERROR。在无阻塞模式在无可用数据或接受到SSH_AGAIN时返回0</p>
<p>warning：</p>
<p>函数可能返回小于count字节的数据，并在count字节被读取之前不会被阻塞。使用缓存区的读取函数重命名为channel_read_buffer()</p>
<h4 id="示例-5"><a href="#示例-5" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">interactive_shell_session</span><span class="params">(ssh_channel channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	<span class="built_in">string</span> buffer[<span class="number">256</span>];</span><br><span class="line">	<span class="keyword">int</span> nbytes;</span><br><span class="line"></span><br><span class="line">	rc = ssh_channel_request_pty(channel);</span><br><span class="line">	<span class="keyword">if</span> (rc!=SSH_OK) <span class="keyword">return</span> rc;</span><br><span class="line">	</span><br><span class="line">	rc = ssh_channel_change_ptu_size(channel,<span class="number">80</span>,<span class="number">24</span>);</span><br><span class="line">	<span class="keyword">if</span> (rc!=SSH_OK) <span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	rc = ssh_channel_request_shell(channel);</span><br><span class="line">	<span class="keyword">if</span> (rc!=SSH_OK) <span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(ssh_channel_is_open(channel)&amp;&amp;!ssh_channel_is_eof(channel))</span><br><span class="line">	&#123;</span><br><span class="line">		nbytes = ssh_channel_read(channel,buffer,<span class="keyword">sizeof</span>(buffer),<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (nbytes&lt;<span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (nbytes&gt;<span class="number">0</span>)</span><br><span class="line">			write(<span class="number">1</span>,buffer,nbytes);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="像远程主机发送用户输入"><a href="#像远程主机发送用户输入" class="headerlink" title="像远程主机发送用户输入"></a>像远程主机发送用户输入</h3><p>使用ssh_channel_write()向远程站点发送数据</p>
<h4 id="ssh-channel-write"><a href="#ssh-channel-write" class="headerlink" title="ssh_channel_write()"></a>ssh_channel_write()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_channel_write</span><span class="params">(ssh_channel channel,<span class="keyword">const</span> <span class="keyword">void</span>* data,<span class="keyword">uint32_t</span> len)</span></span></span><br></pre></td></tr></table></figure>

<p>向信道写入块数据</p>
<p>参数：</p>
<ul>
<li>channel 将要写入的信道</li>
<li>data 指向要写入的数据的指针</li>
<li>len 写入的缓冲区的长度</li>
</ul>
<p>返回：写入的字节数；出错时返回SSH_ERROR</p>
<h4 id="示例-6"><a href="#示例-6" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kbhit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span> = &#123;</span><span class="number">0L</span>,<span class="number">0L</span>&#125;</span><br><span class="line">	fd_set fdsl</span><br><span class="line"></span><br><span class="line">	FD_ZERO(&amp;fds);</span><br><span class="line">	FD_SET(<span class="number">0</span>,&amp;fds);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> select(<span class="number">1</span>,&amp;fds,<span class="literal">NULL</span>,<span class="literal">NULL</span>,&amp;tv);</span><br><span class="line">&#125;<span class="comment">//用于Linux系统下检测键盘输入，Windows下是标准函数，不能重复定义 有键盘输入返回1，否则为0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">interactive_shell_session</span><span class="params">(ssh_channel channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buffer[<span class="number">256</span>];</span><br><span class="line">	<span class="keyword">int</span> nbytes,nwritten;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (ssh_channel_is_open(channel)&amp;&amp;!ssh_channel_is_eof(channel))<span class="comment">//信道开启且不是结束符</span></span><br><span class="line">	&#123;</span><br><span class="line">		nbytes = ssh_channel_read_nonblocking(channel,buffer,<span class="keyword">sizeof</span>(buffer),<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) <span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">		<span class="keyword">if</span> (nbytes &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			nwritten = write(<span class="number">1</span>,buffer,nbytes);</span><br><span class="line">			<span class="keyword">if</span> (nwritten != nbytes) <span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!kbhit())<span class="comment">//如果键盘没有输入，挂起进程等待0.05秒</span></span><br><span class="line">		&#123;</span><br><span class="line">			usleep(<span class="number">50000L</span>);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">			</span><br><span class="line">		nbytes = read(<span class="number">0</span>,buffer,<span class="keyword">sizeof</span>(buffer));</span><br><span class="line">		<span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>) <span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">		<span class="keyword">if</span> (nbytes &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			nwritten = ssh_channel_write(channel,buffer,nbytes);</span><br><span class="line">			<span class="keyword">if</span> (nwritten != nbytes) <span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ssh-channel-is-open"><a href="#ssh-channel-is-open" class="headerlink" title="ssh_channel_is_open()"></a>ssh_channel_is_open()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_channel_is_open</span><span class="params">(ssh_channel channel)</span></span></span><br></pre></td></tr></table></figure>

<p>检查信道是否开启</p>
<p>返回：信道关闭返回0，其他情况返回非0值</p>
<h3 id="在远程终端使用图形界面"><a href="#在远程终端使用图形界面" class="headerlink" title="在远程终端使用图形界面"></a>在远程终端使用图形界面</h3><p>图形界面的远程终端，可以通过X11协议将图形界面转发到本地</p>
<p>首先声明接受ssh_channel_accept_x11()的X11连接，然后使用ssh_channel_request_x11为X11协议创建转发隧道</p>
<h4 id="ssh-channel-accept-x11"><a href="#ssh-channel-accept-x11" class="headerlink" title="ssh_channel_accept_x11()"></a>ssh_channel_accept_x11()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ssh_channel <span class="title">ssh_channel_accept_x11</span><span class="params">(ssh_channel channel,<span class="keyword">int</span> timeout_ms)</span></span></span><br></pre></td></tr></table></figure>

<p>接受X11转发信道</p>
<p>参数：</p>
<ul>
<li>channel 允许X11会话的信道</li>
<li>timeout_ms 微秒为单位的超时值</li>
</ul>
<p>返回：新建立的信道，或当没有从服务器来的X11请求时返回NULL</p>
<h4 id="ssh-channel-request-x11"><a href="#ssh-channel-request-x11" class="headerlink" title="ssh_channel_request_x11()"></a>ssh_channel_request_x11()</h4><p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_channel_request_x11</span><span class="params">(ssh_channel channel,<span class="keyword">int</span> single_connetion,<span class="keyword">const</span> <span class="keyword">char</span>* protocol,<span class="keyword">const</span> <span class="keyword">char</span>* cookie,<span class="keyword">int</span> screen_number)</span></span></span><br></pre></td></tr></table></figure>

<p>通过现有的会话信道发送X11(x11-req)请求，将远程X11应用的显示重定向到本地X服务器</p>
<p>参数：</p>
<ul>
<li>channel 一个用来执行X11程序的现有会话信道</li>
<li>single_connection 标记是否只有单个X11应用被重定向的布尔值</li>
<li>protocol X11身份认证协议，传递NULL使用默认值MIT-MAGIC-COOKIE-1</li>
<li>cookie X11协议cookie，传递NULL生成你随机cookie</li>
<li>screen_number 屏幕号</li>
</ul>
<p>返回：成功时返回SSH_OK,出错时返回SSH_ERROR，非阻塞模式下需要重新调用返回SSH_AGAIN</p>
<h4 id="示例-7"><a href="#示例-7" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">interactive_shell_session</span><span class="params">(ssh_channel channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	ssh_channel x11channel;</span><br><span class="line"></span><br><span class="line">	rc = ssh_channel_request_pty(channel);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK) <span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	rc = ssh_channel_change_pty_size(channel,<span class="number">80.24</span>);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK) <span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	rc = ssh_channel_request_x11(channel,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(rc != SSH_OK) <span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	rc = ssh_channel_request_shell(channel);</span><br><span class="line">	<span class="keyword">if</span> (rc = !=SSH_OK) <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Chapter4-传递远程命令"><a href="#Chapter4-传递远程命令" class="headerlink" title="Chapter4:传递远程命令"></a>Chapter4:传递远程命令</h2><p>该方法只适用于执行一个远程命令，如果要发出多个命令，应使用非交互式远程shell</p>
<h3 id="执行远程命令"><a href="#执行远程命令" class="headerlink" title="执行远程命令"></a>执行远程命令</h3><h4 id="1-打开一个SSH信道"><a href="#1-打开一个SSH信道" class="headerlink" title="1.打开一个SSH信道"></a>1.打开一个SSH信道</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">show_remote_files</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ssh_channel channel;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">	channel = ssh_channel_new(session);</span><br><span class="line">	<span class="keyword">if</span> (channel == <span class="literal">NULL</span>) <span class="keyword">return</span> SSH_ERROR;<span class="comment">//创建一个信道</span></span><br><span class="line"></span><br><span class="line">	rc = ssh_channel_open_session(channel);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		ssh_channel_free(channel);<span class="comment">//如果不能开启会话，释放掉当前信道</span></span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-执行远程命令"><a href="#2-执行远程命令" class="headerlink" title="2.执行远程命令"></a>2.执行远程命令</h4><p>调用ssh_channel_request_exec()执行远程命令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rc = ssh_channel_request_exec(channel,<span class="string">"ls -l"</span>);</span><br><span class="line"><span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">&#123;</span><br><span class="line">	ssh_channel_close(channel);</span><br><span class="line">	ssh_channel_free(channel);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ssh_channel_request_exec()</p>
<p>定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_channel_request_exec</span><span class="params">(ssh_channel channel,<span class="keyword">const</span> <span class="keyword">char</span>* cmd)</span></span></span><br></pre></td></tr></table></figure>

<p>运行一条没有交互式shell的shell命令，类似于执行’sh -c command’</p>
<p>参数：</p>
<ul>
<li>channel 执行命令的信道</li>
<li>cmd 执行的命令</li>
</ul>
<p>返回：成功时返回SSH_OK,出错时返回SSH_ERROR，非阻塞模式下需要重新调用返回SSH_AGAIN</p>
<h4 id="3-获取数据"><a href="#3-获取数据" class="headerlink" title="3.获取数据"></a>3.获取数据</h4><p>远程命令显示数据，调用ssh_channel_read()获取数据。改善书返回读取的字节数。如果信道上没有更多数据，则函数返回0，转到下一步；如果月到错误，则返回负值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buffer[<span class="number">256</span>];</span><br><span class="line"><span class="keyword">int</span> nbytes;</span><br><span class="line"></span><br><span class="line">nbytes = ssh_channel_read(channel,buffer,<span class="keyword">sizeof</span>(buffer),<span class="number">0</span>);</span><br><span class="line"><span class="keyword">while</span> (nbytes &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (fwrite(buffer,<span class="number">1</span>,bytes,<span class="built_in">stdout</span>)！=nbytes)</span><br><span class="line">	&#123;</span><br><span class="line">		ssh_channel_close(channel);</span><br><span class="line">		ssh_channel_free(channel);</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line">	nbytes = ssh_channel_read(channel,buffer,<span class="keyword">sizeof</span>(buffer),<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">	ssh_channel_close(channel);</span><br><span class="line">	ssh_channel_free(channel);</span><br><span class="line">	<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-结束"><a href="#4-结束" class="headerlink" title="4.结束"></a>4.结束</h4><p>读取远程命令的结果后，将文件结束符EOF发送到信道，关闭信道并释放信道</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh_channel_send_eof(channel);</span><br><span class="line">ssh_channel_close(channel);</span><br><span class="line">ssh_channel_free(channel);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> SSH_OK</span><br></pre></td></tr></table></figure>

<h2 id="Chapter-5-SFTP子系统"><a href="#Chapter-5-SFTP子系统" class="headerlink" title="Chapter 5:SFTP子系统"></a>Chapter 5:SFTP子系统</h2><p>SFTP是安全文件传输协议的简称,可以用于本地与远程计算机的远程传输.SFTP的功能丰富,现有的版本是版本3,虽然未解决全部功能,但核心功能已经实现</p>
<h3 id="打开和关闭SFTP会话"><a href="#打开和关闭SFTP会话" class="headerlink" title="打开和关闭SFTP会话"></a>打开和关闭SFTP会话</h3><p>SFTP子系统不是打开一个SSH信道,而是开启一个SFTP会话</p>
<p>用sftp_new()创建一个新的SFTP会话,用函数sftp_free()初始化,sftp_free()删除.</p>
<h4 id="示例-8"><a href="#示例-8" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libssh/sftp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_helloworld</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	sftp_session sftp;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">	sftp = sftp_new(session);</span><br><span class="line">	<span class="keyword">if</span> (sftp = <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error allocationg SFTP session:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rc = sftp_init(sftp);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error initializing SFTP session:%s.\n"</span>,sftp_get_error(sftp));</span><br><span class="line">		sftp_free(sftp);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sftp_free(sftp);</span><br><span class="line">	<span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="sftp-new"><a href="#sftp-new" class="headerlink" title="sftp_new()"></a>sftp_new()</h4><p>定义:</p>
<pre><code>sftp_session sftp_new(ssh_session session)</code></pre><p>返回:正确分配一个sftp会话或错误时返回NULL</p>
<p>需要使用stfp_free()进行释放</p>
<h4 id="sftp-init"><a href="#sftp-init" class="headerlink" title="sftp_init()"></a>sftp_init()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_init</span><span class="params">(sftp_session sftp)</span></span></span><br></pre></td></tr></table></figure>

<p>参数:sftp:将要初始化的sftp会话</p>
<p>返回:成功时返回0,失败时返回&lt;0的值并抛出ssh错误</p>
<h4 id="sftp-free"><a href="#sftp-free" class="headerlink" title="sftp_free()"></a>sftp_free()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sftp_free</span><span class="params">(sftp_session sftp)</span></span></span><br></pre></td></tr></table></figure>

<p>关闭并释放一个sftp会话</p>
<h3 id="SFTP错误"><a href="#SFTP错误" class="headerlink" title="SFTP错误"></a>SFTP错误</h3><p>产生错误时,除ssh_get_error_number()抛出常规SSH错误外,使用sftp_get_error()返回SFTP错误号</p>
<h4 id="sftp-get-error"><a href="#sftp-get-error" class="headerlink" title="sftp_get_error()"></a>sftp_get_error()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_get_error</span><span class="params">(sftp_session sftp)</span></span></span><br></pre></td></tr></table></figure>

<p>获取最后一个错误</p>
<p>返回:保存的错误,如果函数出错返回&lt;0</p>
<h4 id="错误编号"><a href="#错误编号" class="headerlink" title="错误编号"></a>错误编号</h4><ul>
<li>SSH_FX_OK: 无错误</li>
<li>SSH_FX_\EOF: 遇到文件结束符EOF</li>
<li>SSH_FX_NO_SUCH_FILE: 文件不存在</li>
<li>SSH_FX_PERMISSION_DENIED: 权限被拒绝</li>
<li>SSH_FX_FAILURE: 通配失败</li>
<li>SSH_FX_BAD_MESSAGE: 从服务器收到garbage</li>
<li>SSH_FX_NO_CONNECTION: 未建立链接</li>
<li>SSH_FX_CONNECTION_LOST: 存在链接但已丢失</li>
<li>SSH_FX_OP_UNSUPPORTED: 操作不受libssh支持</li>
<li>SSH_FX_INVALID_HANDLE: 无效的文件句柄</li>
<li>SSH_FX_NO_SUCH_PATH: 不存在此文件或目录</li>
<li>SSH_FX_FILE_ALREADY_EXISTS: 尝试创建已经存在的文件或目录</li>
<li>SSH_FX_WRITE_PROTECT: 写保护的文件系统</li>
<li>SSH_FX_NO_MEDIA: 远程驱动中没有介质</li>
</ul>
<h3 id="创建一个目录"><a href="#创建一个目录" class="headerlink" title="创建一个目录"></a>创建一个目录</h3><p>通过sftp_mkdir()创建目录,目录权限和mkdir函数相同.所需的权限与远程用户的掩码组合确定有效权限</p>
<h4 id="示例-9"><a href="#示例-9" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libssh/sftp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_helloworld</span><span class="params">(ssh_session session,sftp_session sftp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">	rc = sftp_mkdir(sftp,<span class="string">"helloworld"</span>,S_IRWXU);</span><br><span class="line">	<span class="keyword">if</span> (rc!=SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (sftp_get_error(sftp)!=SSH_FX_FILE_ALREADY_EXISTS)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"无法创建目录:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">			<span class="keyword">return</span> rc;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="sftp-mkdir"><a href="#sftp-mkdir" class="headerlink" title="sftp_mkdir()"></a>sftp_mkdir()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_mkdir</span><span class="params">(sftp_session sftp,<span class="keyword">const</span> <span class="keyword">char</span>* directory,<span class="keyword">mode_t</span> mode)</span></span></span><br></pre></td></tr></table></figure>

<p>创建目录</p>
<p>参数:</p>
<ul>
<li>sftp sftp会话的句柄</li>
<li>diretory 将要创建的目录</li>
<li>mode 指定要使用的权限.由进程的umask掩码进行修饰,通常以创建文件的(mode&amp;~umask)(即mode与用户掩码umask进行位与后的结果)方式决定权限</li>
</ul>
<p>返回:成功时返回0,错误时返回&lt;0并抛出ssh和sftp错误</p>
<p>与SCP系统中不同,该函数不会将当前目录切换到新创建的目录中</p>
<h3 id="向远程计算机拷贝文件"><a href="#向远程计算机拷贝文件" class="headerlink" title="向远程计算机拷贝文件"></a>向远程计算机拷贝文件</h3><p>可以像处理本地文件一样处理远程文件的内容:以特定模式打开文件,移动文件指针,读取或写入数据以及关闭文件</p>
<p>调用sftp_open()函数,该函数类似与本地的open()函数,并额外返回一个sftp_file类型的文件句柄,该文件句柄可以由其他文件操作函数使用,并保持有效直到调用sftp_close()关闭该远程文件</p>
<h4 id="示例-10"><a href="#示例-10" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libssh/sftp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_helloworld</span><span class="params">(ssh_session session,sftp_session sftp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> access_type  = O_WRONLY | O_CREAT | O_TRUNC;</span><br><span class="line">	sftp_file file;<span class="comment">//open()函数参数设定,写模式,不存在文件新建,以存在文件,长度被截为0</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *helloworld = <span class="string">"Hello,World!\n"</span>;</span><br><span class="line">	<span class="keyword">int</span> length = <span class="built_in">strlen</span>(helloworld);</span><br><span class="line">	<span class="keyword">int</span> rc,nwritten;</span><br><span class="line"></span><br><span class="line">	file = sftp_open(sftp,<span class="string">"helloworld/helloworld.txt"</span>,access_type,S_IPWXU);</span><br><span class="line">	<span class="keyword">if</span> (file == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't open file for writing:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nwritten = sftp_write(file,helloworld,length);</span><br><span class="line">	<span class="keyword">if</span> (nwritten != length)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't write data to file:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">		sftp_close(file);</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rc = sftp_close(file);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't close the written file:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="sftp-open"><a href="#sftp-open" class="headerlink" title="sftp_open()"></a>sftp_open()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sftp_file <span class="title">sftp_open</span><span class="params">(sftp_session session,<span class="keyword">const</span> <span class="keyword">char</span>* file,<span class="keyword">int</span> accessype,<span class="keyword">mode_t</span> mode)</span></span></span><br></pre></td></tr></table></figure>

<p>在远程服务器打开(创建)文件</p>
<p>参数:</p>
<ul>
<li>session sftp会话句柄</li>
<li>file 将要打开的文件(指针)</li>
<li>accesstype open函数参数,指定文件操作类型等参数</li>
<li>mode 如果要创建新文件,指定要使用的权限.由进程的umask掩码进行修饰,通常以创建文件的(mode&amp;~umask)(即mode与用户掩码umask进行位与后的结果)方式决定权限</li>
</ul>
<p>返回:成功时返回文件句柄(指针),错误时返回NULL并抛出ssh和sftp错误</p>
<h4 id="sftp-close"><a href="#sftp-close" class="headerlink" title="sftp_close()"></a>sftp_close()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_close</span><span class="params">(sftp_file file)</span></span></span><br></pre></td></tr></table></figure>

<p>释放指针关闭打开的文件句柄</p>
<p>返回:正常关闭时返回SSH_NO_\ERROR,发生错误是返回SSH_ERROR</p>
<h3 id="从远程计算机读取文件"><a href="#从远程计算机读取文件" class="headerlink" title="从远程计算机读取文件"></a>从远程计算机读取文件</h3><p>通过sftp读取网络文件,可以通过同步或一部两种方式完成</p>
<p>同步读取使用sftp_read()完成</p>
<h4 id="同步读取文件"><a href="#同步读取文件" class="headerlink" title="同步读取文件"></a>同步读取文件</h4><p>调用sftp_read()函数.文件通常以块形式传输,一个好的文件块大小是16KB.</p>
<p><strong>示例</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以16KB文件块远程打开"/etc/profile"文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_XFER_BUF_SIZE 16384  <span class="comment">//16KB</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_read_sync</span><span class="params">(ssh_session session,sftp_session sftp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> access_type;</span><br><span class="line">	sftp_file file;</span><br><span class="line">	<span class="keyword">char</span> buffer[MAX_XFER_BUF_SIZE];</span><br><span class="line">	<span class="keyword">int</span> nbytes,nwritten,rc;</span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">	access_type = O_RDONLY;</span><br><span class="line">	file = sftp_open(sftp,<span class="string">"etc/profile"</span>,access_type,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (file == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't open file for reading:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fd = open(<span class="string">"/path/to/profile"</span>,O_CREAT);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't open file for writing:%s\n"</span>,strerror(session));</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(;;)<span class="comment">//读取文件块直到缓存区为空</span></span><br><span class="line">	&#123;</span><br><span class="line">		nbytes = sftp_read(file,buffer,<span class="keyword">sizeof</span>(buffer));</span><br><span class="line">		<span class="keyword">if</span> (nbytes == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error while reading file:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">			sftp_close(file);</span><br><span class="line">			<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		nwritten = write(fd,buffer,nbytes);</span><br><span class="line">		<span class="keyword">if</span> (nwritten != nbytes)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error writing:%s\n"</span>,strerror(errno));</span><br><span class="line">			sftp_close(file);</span><br><span class="line">			<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rc = sftp_close(file);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't close the read file:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>sftp_read()</strong></p>
<p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> sftp_read(sftp_file file,<span class="keyword">void</span>* buf,<span class="keyword">size_t</span> count)</span><br></pre></td></tr></table></figure>

<p>从打开的文件句柄(文件指针)中读取文件</p>
<p>参数:</p>
<ul>
<li>file 打开的文件指针</li>
<li>buf 接收文件内容的缓存区指针</li>
<li>count 以字节为单位的缓存区大小</li>
</ul>
<p>返回:写入的数据字节数,发生错误时返回&lt;0并抛出ssh和sftp错误</p>
<h4 id="异步读取数据"><a href="#异步读取数据" class="headerlink" title="异步读取数据"></a>异步读取数据</h4><p>异步读取分两步完成,首先调用sftp_asyns_read_begin(),返回一个请求句柄</p>
<p>然后调用sftp_async_read(),使用该句柄.如果文件以非阻塞模式打开,则该函数可能会返回SSH_AGAIN,此时请求尚未完成,需要稍后重新调用.否则调用sftp_async_read()等待数据到来</p>
<p>以非阻塞模式打开文件,需要在打开文件后立即调用sftp_set_nonblocking()函数(默认时阻塞模式)</p>
<p><strong>示例</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_XFER_BUF_SIZE 16384</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_read_async</span><span class="params">(ssh_session,sftp_sesison sftp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> access_type;</span><br><span class="line">	sftp_file file;</span><br><span class="line">	<span class="keyword">char</span> buffer [MAX_XFER_BUF_SIZE];</span><br><span class="line">	<span class="keyword">int</span> async_request;</span><br><span class="line">	<span class="keyword">int</span> nbytesl</span><br><span class="line">	<span class="keyword">long</span> counter;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">	access_type = O_RDONLY;</span><br><span class="line">	file = sftp_open(sftp,<span class="string">"some_very_big_file"</span>,access_type,<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (file == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't open file for reading:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line">	sftp_file_set_nonblocking(file);</span><br><span class="line"></span><br><span class="line">	async_request = sftp_async_read_begin(file,<span class="keyword">sizeof</span>(buffer));</span><br><span class="line">	counter = <span class="number">0L</span>;</span><br><span class="line">	usleep(<span class="number">10000</span>);</span><br><span class="line">	<span class="keyword">if</span> (async_request &gt;= <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		nbytes = sftp_async_read(file,buffer,<span class="keyword">sizeof</span>(buffer),async_request);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		nbytes = <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (nbytes &gt; <span class="number">0</span>)||nbytes == SSH_AGAIN)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (nbytes &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			write(<span class="number">1</span>,buffer,nbytes);</span><br><span class="line">			async_request = sftp_async_read_begin(file,<span class="keyword">sizeof</span>(buffer));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			counter++;</span><br><span class="line">		&#125;</span><br><span class="line">		usleep(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (async_request &gt;= <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			nbytes = sftp_async_read(file,buffer,<span class="keyword">sizeof</span>(buffer),async_request);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			nbytes = <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error while reading file:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">		sftp_close(file);</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"The counter has reached value: %ld\n"</span>,counter);</span><br><span class="line"></span><br><span class="line">	rc = sftp_close(file);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't close the read file:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>sftp_async_read_begin()</strong></p>
<p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_async_read_begin</span><span class="params">(sftp_file file,<span class="keyword">uint32_t</span> len)</span></span></span><br></pre></td></tr></table></figure>

<p>使用打开的sftp文件句柄进行异步读取.目标是避免与同步读取方式/响应模式相关的慢速读取</p>
<p>参数:</p>
<ul>
<li>file 读取的打开的文件句柄</li>
<li>len 将要读取的字节数</li>
</ul>
<p>返回:与发送的请求对应的响应符,错误时返回&lt;0</p>
<blockquote>
<p><strong>warning</strong>:</p>
</blockquote>
<blockquote>
<p>调用该函数时,内部偏移量将会根据len参数进行更新,调用该函数会向服务器发送请求,若服务器应答,libssh非配内存存储响应,直到sftp_async_read()被调用.如果不调用sftp_async_read()会导致内存泄漏</p>
</blockquote>
<p><strong>sftp_async_read()</strong></p>
<p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_async_read</span><span class="params">(sftp_file file,<span class="keyword">void</span>* data,<span class="keyword">uint32_t</span> len,<span class="keyword">uint32_t</span> id)</span></span></span><br></pre></td></tr></table></figure>

<p>等待异步传输读取完成并保存数据</p>
<p>参数:</p>
<ul>
<li>file 将要被读取的文件句柄</li>
<li>data 指向接收数据的缓存区的指针</li>
<li>len 以字节为单位的缓存区的大小,应该大于等于sftp_async_read_begin()调用的长度参数</li>
<li>id sftp_async_read_begin()返回的标识符</li>
</ul>
<p>返回:读取的字节数;遇到EOF文件结束符返回0;错误时返回SSH_ERROR;阻塞模式返回SSH_AGAIN并需要之后再次访问</p>
<blockquote>
<p><strong>warning</strong>:</p>
</blockquote>
<blockquote>
<p>使用无效标识符调用该函数将永远不会返回</p>
</blockquote>
<p><strong>sftp_file_set_nonblocking()</strong></p>
<p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sftp_file_set_nonblocking</span><span class="params">(sftp_file handle)</span></span></span><br></pre></td></tr></table></figure>

<p>将传入的文件句柄设置为无阻塞通信模式</p>
<h3 id="列出目录的内容"><a href="#列出目录的内容" class="headerlink" title="列出目录的内容"></a>列出目录的内容</h3><p>使用handle_type:sftp_dir的句柄类型,访问正在读取的目录</p>
<h4 id="sftp-opendir"><a href="#sftp-opendir" class="headerlink" title="sftp_opendir()"></a>sftp_opendir()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sftp_dir <span class="title">sftp_opendir</span><span class="params">(sftp_session session,<span class="keyword">const</span> <span class="keyword">char</span>* path)</span></span></span><br></pre></td></tr></table></figure>

<p>打开一个用于获取远程目录条目的目录</p>
<p>参数:</p>
<ul>
<li>session 打开目录的sftp句柄</li>
<li>path 将要打开的目录地址</li>
</ul>
<p>返回:成功时返回目录的sftp句柄 错误时返回NULL并抛出ssh和sftp错误</p>
<h4 id="sftp-readdir"><a href="#sftp-readdir" class="headerlink" title="sftp_readdir()"></a>sftp_readdir()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sftp_attributes <span class="title">sftp_readdir</span><span class="params">(sftp_session,sftp_dir dir)</span></span></span><br></pre></td></tr></table></figure>

<p>获取目录的单个文件属性结构</p>
<p>参数:</p>
<ul>
<li>session 将要读取的目录的sftp会话句柄</li>
<li>dir 将要读取的目录的sftp句柄</li>
</ul>
<p>返回:文件属性结构,出错或目录结尾处返回NULL</p>
<blockquote>
<p>文件属性结构 即一个sftp_attributes类型,是一个指向具有目录条目信息结构的指针:</p>
</blockquote>
<blockquote>
<ul>
<li>name:目录或文件的名称</li>
<li>size:以比特为单位的大小</li>
<li>等等其他属性</li>
</ul>
</blockquote>
<blockquote>
<p>在出错或目录结尾处可能会返回NULL.通过sftp_dir_eof()判断是否目录结尾</p>
</blockquote>
<p>不需要时,必须用sftp_attributes_free()释放属性</p>
<h4 id="sftp-dir-eof"><a href="#sftp-dir-eof" class="headerlink" title="sftp_dir_eof()"></a>sftp_dir_eof()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_dir_eof</span><span class="params">(sftp_dir dir)</span></span></span><br></pre></td></tr></table></figure>

<p>确定是否达到了文件结束符EOF</p>
<p>参数:dir sftp目录句柄</p>
<p>返回:是EOF时返回1,不是则返回0</p>
<h4 id="sftp-closedir"><a href="#sftp-closedir" class="headerlink" title="sftp_closedir()"></a>sftp_closedir()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_closedir</span><span class="params">(sftp_dir dir)</span></span></span><br></pre></td></tr></table></figure>

<p>关闭目录句柄</p>
<p>返回:SSH_NO_ERROR或SSH_ERROR</p>
<h4 id="sftp-attributes-free"><a href="#sftp-attributes-free" class="headerlink" title="sftp_attributes_free()"></a>sftp_attributes_free()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sftp_attributes_free</span><span class="params">(sftp_attributes file)</span></span></span><br></pre></td></tr></table></figure>

<p>释放sftp属性结构的指针</p>
<h4 id="示例-11"><a href="#示例-11" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sftp_list_dir</span><span class="params">(ssh_session,sftp_session sftp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	sftp_dir dir;</span><br><span class="line">	sftp_attributes attributes;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">	dir = sftp_opendir(sftp,<span class="string">"/var/log"</span>);</span><br><span class="line">	<span class="keyword">if</span> (!dir)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Directory not opened:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Name          Size Perms	Owner\tGroup\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>((attributes = sftp_readdir(sftp,dir)) != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"%-20s %10llu %.8o %s(%d)\t%s(%d)\n"</span>,attributes-&gt;name,(<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)attributes-&gt;size,attributes-&gt;permissions,attributes-&gt;owner,attributes-&gt;uid,attributes-&gt;group,attributes-&gt;gid);</span><br><span class="line"></span><br><span class="line">		sftp_attributes_free(attributes);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!sftp_dir_eof(dir))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't list directory: %s\n"</span>,ssh_get_error(session));</span><br><span class="line">		sftp_closedir(dir);</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rc = sftp_closedir(dir);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't close directory: %s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Chapter-6-SCP子系统"><a href="#Chapter-6-SCP子系统" class="headerlink" title="Chapter 6:SCP子系统"></a>Chapter 6:SCP子系统</h2><p>SCP子系统的功能远远少于SFTP子系统,但如果只需要从远程系统复制文件,SCP可以胜任</p>
<h3 id="开启-关闭SCP会话"><a href="#开启-关闭SCP会话" class="headerlink" title="开启/关闭SCP会话"></a>开启/关闭SCP会话</h3><p>SCP子系统中,不直接操作SSH信道,而是开启一个SCP会话</p>
<p>SCP会话中不能同时进行读和写的操作,需要在调用ssh_scp_new()函数时指定读写模式</p>
<p>另一个重要的模式参数是SSH_SCP_RECURSIVE,声明是否使用递归读取目录的方式</p>
<p>ssh_scp_new()创建会话,ssh_scp_init()进行初始化.完成传输后,使用ssh_scp_close()终止SCP链接,并调用ssh_scp_free()释放分配的连接</p>
<h4 id="示例1-递归写入"><a href="#示例1-递归写入" class="headerlink" title="示例1:递归写入"></a>示例1:递归写入</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">scp_write</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ssh_scp scp;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">	scp = ssh_scp_new(session,SSH_SCP_WRITE|SSH_SCP_RECURSIVE,<span class="string">"."</span>);</span><br><span class="line">	<span class="keyword">if</span> (scp == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error allocating scp session:%s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rc = ssh_scp_init(scp);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error initializing scp session: %s\n"</span>);</span><br><span class="line">		ssh_scp_free(scp);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ssh_scp_close(scp);</span><br><span class="line">	ssh_scp_free(scp);</span><br><span class="line">	<span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="示例2-打开连接读取单个文件"><a href="#示例2-打开连接读取单个文件" class="headerlink" title="示例2:打开连接读取单个文件"></a>示例2:打开连接读取单个文件</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">scp_read</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ssh_scp scp;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line"></span><br><span class="line">	scp = ssh_scp_new(session,SSH_SCP_READ,<span class="string">"hello/helloworld.txt"</span>);</span><br><span class="line">	<span class="keyword">if</span> (scp == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error allocating scp session: %s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rc = ssh_scp_init(scp);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error initializing scp session: %s\n"</span>,ssh_get_error(session));</span><br><span class="line">		ssh_scp_free(scp);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ssh_scp_close(scp);</span><br><span class="line">	ssh_scp_free(scp);</span><br><span class="line">	<span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ssh-scp-new"><a href="#ssh-scp-new" class="headerlink" title="ssh_scp_new()"></a>ssh_scp_new()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ssh_scp <span class="title">ssh_scp_new</span><span class="params">(ssh_session session,<span class="keyword">int</span> mode,<span class="keyword">const</span> <span class="keyword">char</span>* location)</span></span></span><br></pre></td></tr></table></figure>

<p>创建一个新的scp会话</p>
<p>参数:</p>
<ul>
<li>session 使用的SSH会话</li>
<li>mode 标志位 SSH_SCP_WRITE/SSH_SCP_READ,选择读/写模式.SSH_SCP_RECURSIVE可以通过位或运算添加到参数中,表示可以递归操作(访问目录必须)</li>
<li>location 写入或读取的目录</li>
</ul>
<p>返回:ssh_scp句柄,失败时返回NULL</p>
<h4 id="ssh-scp-init"><a href="#ssh-scp-init" class="headerlink" title="ssh_scp_init()"></a>ssh_scp_init()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_scp_init</span><span class="params">(ssh_scp scp)</span></span></span><br></pre></td></tr></table></figure>

<p>初始化一个scp信道</p>
<p>返回:成功时返回SSH_OK,失败时返回SSH失败码</p>
<h4 id="ssh-scp-close"><a href="#ssh-scp-close" class="headerlink" title="ssh_scp_close()"></a>ssh_scp_close()</h4><p>关闭scp信道</p>
<p>参数: scp 要关闭的scp连接</p>
<p>返回: 成功时返回SSH_OK,失败时返回SSH错误码</p>
<h4 id="ssh-scp-free"><a href="#ssh-scp-free" class="headerlink" title="ssh_scp_free()"></a>ssh_scp_free()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ssh_scp_free</span><span class="params">(ssh_scp scp)</span></span></span><br></pre></td></tr></table></figure>

<p>释放scp上下文</p>
<h3 id="创建文件和目录"><a href="#创建文件和目录" class="headerlink" title="创建文件和目录"></a>创建文件和目录</h3><p><strong>创建目录:</strong>调用ssh_scp_push_diretory()创建目录.在递归模式下,创建目录后会直接进入该目录.如果目录已经存在,且处于递归模式,直接输入该目录即可</p>
<p><strong>创建文件:</strong>分为两步,先调用ssh_scp_push_file()准备写入;然后调用ssh_scp_write()写入数据.两个函数间要写入的数据长度必须相同.</p>
<p>不需要打开/关闭文件操作,远端自动完成此操作.如果文件已经存在,将会被覆盖并截断</p>
<h4 id="示例-12"><a href="#示例-12" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">scp_helloworld</span><span class="params">(ssh_session session,ssh_scp scp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *helloworld = <span class="string">"Hello\n"</span>;</span><br><span class="line">	<span class="keyword">int</span> length = <span class="built_in">strlen</span>(helloworld);</span><br><span class="line"></span><br><span class="line">	rc = ssh_scp_push_diretory(scp,<span class="string">"helloworld"</span>,S_IRWXU);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't create remote diretory: %s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rc = ssh_scp_push_file(scp,<span class="string">"helloworld.txt"</span>,length,S_IRUSR|S_IWUSR);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't open remote file: %s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rc = ssh_scp_write(scp,helloworld,length);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Can't write to remote file: %s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ssh-scp-push-directory"><a href="#ssh-scp-push-directory" class="headerlink" title="ssh_scp_push_directory()"></a>ssh_scp_push_directory()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_scp_push_diretory</span><span class="params">(ssh_scp scp,<span class="keyword">const</span> <span class="keyword">char</span>* dirname,<span class="keyword">int</span> mode)</span></span></span><br></pre></td></tr></table></figure>

<p>在sink模式下创建一个目录</p>
<p>参数:</p>
<ul>
<li>scp scp句柄</li>
<li>dirname 将要创建的目录名</li>
<li>mode UNIX权限数值</li>
</ul>
<p>返回:成功创建目录返回SSH_OK,出错时返回SSH_ERROR</p>
<h4 id="ssh-scp-push-file"><a href="#ssh-scp-push-file" class="headerlink" title="ssh_scp_push_file()"></a>ssh_scp_push_file()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_scp_push_file</span><span class="params">(ssh_scp scp,<span class="keyword">const</span> <span class="keyword">char</span>* filename,<span class="keyword">size_t</span> size,<span class="keyword">int</span> mode)</span></span></span><br></pre></td></tr></table></figure>

<p>初始化文件传输</p>
<p>参数:</p>
<ul>
<li>scp scp句柄</li>
<li>filename 将要传输的文件名,不应包含任何路径信息</li>
<li>size 发送文件的字节大小</li>
<li>mode 新文件的UNIX权限</li>
</ul>
<p>返回:如果文件准备好发送,返回SSH_OK;发生错误返回SSH_ERROR</p>
<h4 id="ssh-scp-write"><a href="#ssh-scp-write" class="headerlink" title="ssh_scp_write()"></a>ssh_scp_write()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_scp_write</span><span class="params">(ssh_scp scp,<span class="keyword">const</span> <span class="keyword">void</span>* buffer,<span class="keyword">size_t</span> len)</span></span></span><br></pre></td></tr></table></figure>

<p>写入远程文件</p>
<p>参数:</p>
<ul>
<li>scp scp句柄</li>
<li>buffer 将要写入的缓存区</li>
<li>len 将要吸入的字节数</li>
</ul>
<p>返回:写入成功返回SSH_OK,发生错误返回SSH_ERROR</p>
<h3 id="读取文件和目录"><a href="#读取文件和目录" class="headerlink" title="读取文件和目录"></a>读取文件和目录</h3><p>要接收文件,可以调用ssh_scp_pull_request()向远程端发起请求.</p>
<p>如果函数返回SSH_SCP_REQUEST_NEWFILE,则必须准备好接收文件.</p>
<p>可以调用ssh_scp_request_get_size()获取文件大小并据此分配缓存区.</p>
<p>准备好接收文件后,发送ssh_scp_accept_request(),然后调用ssh_scp_read()读取数据</p>
<h4 id="示例-13"><a href="#示例-13" class="headerlink" title="示例"></a>示例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">scp_receive</span><span class="params">(ssh_session session,ssh_scp scp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	<span class="keyword">int</span> size,mode;</span><br><span class="line">	<span class="keyword">char</span> *filename, *buffer;</span><br><span class="line"></span><br><span class="line">	rc = ssh_scp_pull_request(scp);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_SCP_REQUEST_NEWFILE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error receiving information about file: %s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	size = ssh_scp_request_get_size(scp);</span><br><span class="line">	filename = strdup(ssh_scp_request_get_filename(scp));</span><br><span class="line">	mode = ssh_scp_reqiest_get_permissions(scp);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Receiving file %s, size %d, permissions 0%o\n"</span>,filename,size,mode);</span><br><span class="line">	<span class="built_in">free</span>(filename);</span><br><span class="line"></span><br><span class="line">	buffer = <span class="built_in">malloc</span>(size);</span><br><span class="line">	<span class="keyword">if</span> (buffer == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Memory allocation error\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ssh_scp_accept_request(scp);</span><br><span class="line">	rc = ssh_scp_read(scp, buffer, size);</span><br><span class="line">	<span class="keyword">if</span> (rc = SSH_ERROR)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Error receiving file data: %s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="built_in">free</span>(buffer);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Done\n"</span>);</span><br><span class="line"></span><br><span class="line">	write(<span class="number">1</span>, buffer, size);</span><br><span class="line">	<span class="built_in">free</span>(buffer);</span><br><span class="line"></span><br><span class="line">	rc = ssh_scp_pull_request(scp);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_SCP_REQUEST_EOF)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Unexpected request: %s\n"</span>,ssh_get_error(session));</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ssh-scp-pull-request"><a href="#ssh-scp-pull-request" class="headerlink" title="ssh_scp_pull_request()"></a>ssh_scp_pull_request()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_scp_pull_request</span><span class="params">(ssh_scp scp)</span></span></span><br></pre></td></tr></table></figure>

<p>等待一个scp请求(文件,目录)</p>
<p>返回:</p>
<ul>
<li>SSH_SCP_REQUEST_NEWFILE:另一端在传输一个文件</li>
<li>SSH_SCP_REQUEST_NEWDIR:另一端在传输一个目录</li>
<li>SSH_SCP_ENDDIR:另一端完成了当前目录的传输</li>
<li>SSH_SCP_REQUEST_WARNING:另一端发送了一个警告</li>
<li>SSH_SCP_REQUEST_EOF:另一端完成了文件和数据的传输</li>
<li>SSH_ERROR:发生了错误</li>
</ul>
<h4 id="ssh-scp-request-get-size"><a href="#ssh-scp-request-get-size" class="headerlink" title="ssh_scp_request_get_size()"></a>ssh_scp_request_get_size()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> ssh_scp_request_get_size(ssh_scp scp)</span><br></pre></td></tr></table></figure>

<p>获取另一端传输的文件的大小</p>
<p>返回:将要读取的文件的大小</p>
<blockquote>
<p><strong>Warining:</strong></p>
</blockquote>
<blockquote>
<p>实际大小可能不适合32位文件域,可能会发生截断</p>
</blockquote>
<h4 id="ssh-scp-accept-request"><a href="#ssh-scp-accept-request" class="headerlink" title="ssh_scp_accept_request()"></a>ssh_scp_accept_request()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_scp_accept_request</span><span class="params">(ssh_scp scp)</span></span></span><br></pre></td></tr></table></figure>

<p>接收远程主机传输的文件或创建目录</p>
<p>返回:SSH_OK;SSH_ERROR</p>
<h4 id="ssh-scp-read"><a href="#ssh-scp-read" class="headerlink" title="ssh_scp_read()"></a>ssh_scp_read()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_scp_read</span><span class="params">(ssh_scp scp,<span class="keyword">void</span>* buffer,<span class="keyword">size_t</span> size)</span></span></span><br></pre></td></tr></table></figure>

<p>读取远程文件</p>
<p>参数:</p>
<ul>
<li>scp scp句柄</li>
<li>buffer 目标缓存区</li>
<li>size 缓存区的大小</li>
</ul>
<p>返回:读取的字节数;错误时返回SSH_ERROR</p>
<h4 id="ssh-scp-leave-directory"><a href="#ssh-scp-leave-directory" class="headerlink" title="ssh_scp_leave_directory()"></a>ssh_scp_leave_directory()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_scp_leave_diretory</span><span class="params">(ssh_scp scp)</span></span></span><br></pre></td></tr></table></figure>

<p>离开一个目录</p>
<p>返回:SSH_OK;SSH_ERROR</p>
<h3 id="从远程服务器接收完整的目录数"><a href="#从远程服务器接收完整的目录数" class="headerlink" title="从远程服务器接收完整的目录数"></a>从远程服务器接收完整的目录数</h3><p>以递归模式打开SCP会话,远程端会告知何时更改目录</p>
<p>调用ssh_scp_pull_request()返回SSH_SCP_REQUEST_NEWDIRECTORY时,应使用该本地目录输入;返回SSH_SCP_REQUEST_ENDDIRECTORY时,应离开当前目录.</p>
<h2 id="Chapter7-转发连接-隧道"><a href="#Chapter7-转发连接-隧道" class="headerlink" title="Chapter7: 转发连接(隧道)"></a>Chapter7: 转发连接(隧道)</h2><p>端口转发采用两种不同的SSH协议:直接或反向端口转发.直接端口转发即本地端口转发,反向端口转发即远程端口转发</p>
<h3 id="直接端口转发"><a href="#直接端口转发" class="headerlink" title="直接端口转发"></a>直接端口转发</h3><p>直接端口转发时从客户端向服务器的转发.客户端打开一个隧道,并将任何数据转发给服务器;然后服务器连接到一个终点,终点口语主流在另一台机器或SSH服务器本身上</p>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><pre><code>app-&gt;本地端口-&gt;SSH客户端 ===&gt;SSH服务器-&gt;远程端口-&gt;目标app</code></pre><h4 id="示例-14"><a href="#示例-14" class="headerlink" title="示例"></a>示例</h4><pre><code>Mail client application   Google Mail
         |                     ^
     5555 (任意端口)            |
         |                143 (IMAP2)
        V                    |
    SSH client   =====&gt;   SSH server 

图例:
 --P--&gt;: 通过端口P连接端口
 =====&gt;: SSH隧道</code></pre><p>邮件客户端连接到客户端的端口5555,客户端向服务器建立加密隧道.服务器连接到Google邮件服务器的143端口(终点).本地邮件服务器可以向远程发送邮件</p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">direct_forwarding</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ssh_channel forwarding_channel;</span><br><span class="line">	<span class="keyword">int</span> rc;</span><br><span class="line">	<span class="keyword">char</span> *http_get = <span class="string">"GET / HTTP/1.1\nHost: www.google.com\n\n"</span>;</span><br><span class="line">	<span class="keyword">int</span> nbytes, nwritten;</span><br><span class="line"></span><br><span class="line">	forwarding_channel = ssh_channel_new(session);</span><br><span class="line">	<span class="keyword">if</span> (forwarding_channel == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">	rc = ssh_channel_open_forward(forwarding_channel,<span class="string">"www.google.com"</span>,<span class="number">80</span>,<span class="string">"localhost"</span>,<span class="number">5555</span>);</span><br><span class="line">	<span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">	&#123;</span><br><span class="line">		ssh_channel_free(forwarding_channel);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nbytes = <span class="built_in">strlen</span>(http_get);</span><br><span class="line">	nwritten = ssh_channel_write(forwarding_channel,http_get,nbytes);</span><br><span class="line">	<span class="keyword">if</span> (nbytes != nwritten)</span><br><span class="line">	&#123;</span><br><span class="line">		ssh_channel_free(forwarding_channel);</span><br><span class="line">		<span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ssh_channel_free(forwarding_channel);</span><br><span class="line">	<span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ssh-channel-open-forward"><a href="#ssh-channel-open-forward" class="headerlink" title="ssh_channel_open_forward()"></a>ssh_channel_open_forward()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_channel_open_forward</span><span class="params">(ssh_channel channel,<span class="keyword">const</span> <span class="keyword">char</span>* remotehost,<span class="keyword">int</span> remoteport,<span class="keyword">const</span> <span class="keyword">char</span>* sourcehost,<span class="keyword">int</span> localport)</span></span></span><br></pre></td></tr></table></figure>

<p>端口一个TCP/IP转发信道</p>
<p>参数:</p>
<ul>
<li>channel 分配的信道</li>
<li>remotehost 将要连接的远程地址(域名或IP)</li>
<li>remoteport 远程端口</li>
<li>sourcehost 连接请求的来源主机的数字IP.主要用于记录</li>
<li>localport  发起连接的来源主机的端口.主要用于记录</li>
</ul>
<p>返回:SSH_OK;SSH_ERROR;SSH_AGAIN;</p>
<blockquote>
<p><strong>Warning:</strong></p>
</blockquote>
<blockquote>
<p>该函数不绑定本地端口,也不会自动将套接字的内容发送到信道,仍需要调用channel_read()和channel_write()</p>
</blockquote>
<h4 id="ssh-select"><a href="#ssh-select" class="headerlink" title="ssh_select()"></a>ssh_select()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_select</span><span class="params">(ssh_channel* channels, ssh_channel* outchannels, <span class="keyword">socket_t</span> maxfd, fd_set* readfds, struct timeval* timeout)</span></span></span><br></pre></td></tr></table></figure>

<p>选择系统调用的封装</p>
<p>与select(2)有些类似.不支持重写或异常处理</p>
<p>参数:</p>
<ul>
<li>channels 信道数组的指针由NULL终止,永不支持重写</li>
<li>outchannels 和信道相同大小的数组,不需要初始化</li>
<li>maxfd 来自readfds的最大文件描述符+1</li>
<li>readfds 被选择用于读取的文件描述符fd_set</li>
<li>timeout 毫秒单位超市</li>
</ul>
<p>返回:SSH_OK;SSH_ERROR;被打断时返回SSH_EINTR,重新开始即可</p>
<blockquote>
<p><strong>Warning:</strong></p>
</blockquote>
<blockquote>
<p>libssh在此不可重入(递归调用).意味着在调用此函数时收到了信号,时柄口语调用其他libssh函数的</p>
</blockquote>
<h3 id="反向端口转发"><a href="#反向端口转发" class="headerlink" title="反向端口转发"></a>反向端口转发</h3><p>远程端口转发是有服务器发起的,从服务器向客户端转发,即使客户端主动建立隧道.一旦隧道建成,服务器将持续监听某个端口,一旦端口产生连接,服务器向客户端转发数据</p>
<h4 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h4><p>远程app-&gt;监听端口-&gt;SSH服务器 ===&gt; SSH客户端-&gt;本地端口-&gt;本地app</p>
<h4 id="示例-15"><a href="#示例-15" class="headerlink" title="示例"></a>示例</h4><pre><code> Local mail server    Mail client application
         ^                     |
         |               5555 (任意端口)
     143 (IMAP2)               |
         |                     V
    SSH client   &lt;=====   SSH server

图例:
 --P--&gt;: 通过端口P连接端口
 =====&gt;: SSH信道</code></pre><p>客户端建立隧道,但将用于将服务器上建立的连接转发给客户端</p>
<h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">web_server</span><span class="params">(ssh_session session)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> rc;</span><br><span class="line">  ssh_channel channel;</span><br><span class="line">  <span class="keyword">char</span> buffer[<span class="number">256</span>];</span><br><span class="line">  <span class="keyword">int</span> nbytes, nwritten;</span><br><span class="line">  <span class="keyword">int</span> port = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">char</span> *helloworld = <span class="string">""</span></span><br><span class="line"><span class="string">"HTTP/1.1 200 OK\n"</span></span><br><span class="line"><span class="string">"Content-Type: text/html\n"</span></span><br><span class="line"><span class="string">"Content-Length: 113\n"</span></span><br><span class="line"><span class="string">"\n"</span></span><br><span class="line"><span class="string">"&lt;html&gt;\n"</span></span><br><span class="line"><span class="string">"  &lt;head&gt;\n"</span></span><br><span class="line"><span class="string">"    &lt;title&gt;Hello, World!&lt;/title&gt;\n"</span></span><br><span class="line"><span class="string">"  &lt;/head&gt;\n"</span></span><br><span class="line"><span class="string">"  &lt;body&gt;\n"</span></span><br><span class="line"><span class="string">"    &lt;h1&gt;Hello, World!&lt;/h1&gt;\n"</span></span><br><span class="line"><span class="string">"  &lt;/body&gt;\n"</span></span><br><span class="line"><span class="string">"&lt;/html&gt;\n"</span>;</span><br><span class="line">  rc = ssh_channel_listen_forward(session, <span class="literal">NULL</span>, <span class="number">8080</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span> (rc != SSH_OK)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error opening remote port: %s\n"</span>,</span><br><span class="line">            ssh_get_error(session));</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">  &#125;</span><br><span class="line">  channel = ssh_channel_accept_forward(session, <span class="number">60000</span>, &amp;port);</span><br><span class="line">  <span class="keyword">if</span> (channel == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error waiting for incoming connection: %s\n"</span>,</span><br><span class="line">            ssh_get_error(session));</span><br><span class="line">    <span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    nbytes = ssh_channel_read(channel, buffer, <span class="keyword">sizeof</span>(buffer), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error reading incoming data: %s\n"</span>,</span><br><span class="line">              ssh_get_error(session));</span><br><span class="line">      ssh_channel_send_eof(channel);</span><br><span class="line">      ssh_channel_free(channel);</span><br><span class="line">      <span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(buffer, <span class="string">"GET /"</span>, <span class="number">5</span>)) <span class="keyword">continue</span>;</span><br><span class="line">    nbytes = <span class="built_in">strlen</span>(helloworld);</span><br><span class="line">    nwritten = ssh_channel_write(channel, helloworld, nbytes);</span><br><span class="line">    <span class="keyword">if</span> (nwritten != nbytes)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error sending answer: %s\n"</span>,</span><br><span class="line">              ssh_get_error(session));</span><br><span class="line">      ssh_channel_send_eof(channel);</span><br><span class="line">      ssh_channel_free(channel);</span><br><span class="line">      <span class="keyword">return</span> SSH_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Sent answer\n"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ssh_channel_send_eof(channel);</span><br><span class="line">  ssh_channel_free(channel);</span><br><span class="line">  <span class="keyword">return</span> SSH_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ssh-channel-listen-forward"><a href="#ssh-channel-listen-forward" class="headerlink" title="ssh_channel_listen_forward()"></a>ssh_channel_listen_forward()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_channel_listen_forward</span><span class="params">(ssh_session session, <span class="keyword">const</span> <span class="keyword">char</span>* address, <span class="keyword">int</span> port, <span class="keyword">int</span>* bound_port)</span></span></span><br></pre></td></tr></table></figure>

<p>发送”tcpip-forward”全局请求要求服务器开始监听入站连接</p>
<p>参数:</p>
<ul>
<li>session 发送请求的ssh会话</li>
<li>address 将要监听的服务器上的地址.发送NULL监听服务器支持的所有协议族的所有可用地址</li>
<li>port 要在服务器上绑定的端口.传递0让服务器分配下一个可以的非特权端口</li>
<li>bound_port 获取实际绑定端口的指针.传递NULL忽略该项</li>
</ul>
<p>返回:SSH_OK;SSH_ERROR;SSH_AGAIN</p>
<h4 id="ssh-channel-accept-forward"><a href="#ssh-channel-accept-forward" class="headerlink" title="ssh_channel_accept_forward()"></a>ssh_channel_accept_forward()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ssh_channel <span class="title">ssh_channel_accept_forward</span><span class="params">(ssh_session session, <span class="keyword">int</span> timeout_ms, <span class="keyword">int</span>* destination_port)</span></span></span><br></pre></td></tr></table></figure>

<p>接收传入的TCP/IP转发信道,并获取有关传入连接的信息</p>
<p>参数:</p>
<ul>
<li>session 使用的ssh会话</li>
<li>timeout_ms 以毫秒为单位的超时</li>
<li>destination_port 指向目的端口或NULL指针</li>
</ul>
<p>返回:新创建的信道或NULL</p>
<h3 id="X11隧道"><a href="#X11隧道" class="headerlink" title="X11隧道"></a>X11隧道</h3><h4 id="流程-2"><a href="#流程-2" class="headerlink" title="流程"></a>流程</h4><p>图形应用程序(X11客户端)-&gt;SSH服务器 ===&gt; SSH客户端 -&gt;本地展示(X11服务器)</p>
<p>由客户端创建SSH信道</p>
<h2 id="Chapter8-使用libssh的线程"><a href="#Chapter8-使用libssh的线程" class="headerlink" title="Chapter8: 使用libssh的线程"></a>Chapter8: 使用libssh的线程</h2><p>libssh可以用于多线程应用程序,但<strong>注意</strong>:</p>
<ul>
<li>线程必须在初始化libssh期间初始化,该初始化必须在任何线程上下文以为完成</li>
<li>如果应用程序使用pthreads,则必须链接libssh_threads动态库并使用ssh_threads_pthreads线程对象初始化线程</li>
<li>如果应用程序正在使用其他线程库,则必须实现ssh_threads_callbacks_struct机构的所有方法,并用它初始化libssh</li>
<li>任何时候都可以在线程内部使用不同的会话,并行连接,在不同会话中读/写等.但不能在多个进程中使用单个会话(或单个会话的信道)</li>
</ul>
<h3 id="线程初始化"><a href="#线程初始化" class="headerlink" title="线程初始化"></a>线程初始化</h3><p>先调用ssh_threads_set_callbacks()选择要使用的线程模型,然后调用ssh_init()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libssh/callback.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">ssh_threads_set_callbacks(ssh_threads_get_noop());</span><br><span class="line">ssh_init();</span><br></pre></td></tr></table></figure>

<p>ssh_threads_noop时不执行任何操作的线程结构,时不适用线程时默认使用的线程回调</p>
<h4 id="ssh-threads-set-callbacks"><a href="#ssh-threads-set-callbacks" class="headerlink" title="ssh_threads_set_callbacks()"></a>ssh_threads_set_callbacks()</h4><p>定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ssh_threads_set_callbacks</span><span class="params">(struct ssh_threads_callbacks_struct* cb)</span></span></span><br></pre></td></tr></table></figure>

<p>设置线程回调结构</p>
<p>如果要以多线程方式使用libssh,则该函数时必须的.在调用ssh_init()之前,必须调用该函数,而不是在线程上下文</p>
<p>参数:cb 指向ssh_threads_callbacks_struct结构的指针,包含要设置的不同回调</p>
<p>返回:总返回SSH_OK</p>
<h3 id="在libssh中使用libpthread"><a href="#在libssh中使用libpthread" class="headerlink" title="在libssh中使用libpthread"></a>在libssh中使用libpthread</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libssh/callbacks.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">ssh_threads_set_callbacks(ssh_threads_get_pthread());</span><br><span class="line">ssh_init();</span><br></pre></td></tr></table></figure>

<p>必须确保与ssh_threads链接.如果使用gcc,必须使用命令行</p>
<pre><code>gcc -o output input.c -lssh -lssh_threads</code></pre>
      
    </div>

    

    
    
    

    

    
      
    
    

    
      <div>
        




  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Simest</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="https://sim41.com/2019/06/19/libssh/" title="libssh">https://sim41.com/2019/06/19/libssh/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/ssh/" rel="tag"># ssh</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/18/ssh-protocol/" rel="next" title="ssh-protocol">
                <i class="fa fa-chevron-left"></i> ssh-protocol
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/20/openssh/" rel="prev" title="openssh">
                openssh <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Simest">
            
              <p class="site-author-name" itemprop="name">Simest</p>
              <div class="site-description motion-element" itemprop="description">Focus on database/Linux/C/go/docker</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
             <div class="cc-license motion-element" itemprop="license">
              
              
                
              
              
              
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
             </div>
          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#libssh库简介"><span class="nav-number">1.</span> <span class="nav-text">libssh库简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-1-SSH会话示例"><span class="nav-number">1.1.</span> <span class="nav-text">Chapter 1:SSH会话示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建会话并设置选项"><span class="nav-number">1.1.1.</span> <span class="nav-text">创建会话并设置选项</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-new"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">ssh_new()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-buffer-new"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">ssh_buffer_new()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-set-blocking"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">ssh_set_blocking()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-free"><span class="nav-number">1.1.1.4.</span> <span class="nav-text">ssh_free()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-options-set"><span class="nav-number">1.1.1.5.</span> <span class="nav-text">ssh_options_set()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#连接到服务器"><span class="nav-number">1.1.2.</span> <span class="nav-text">连接到服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-connect"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">ssh_connect()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-get-error"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">ssh_get_error()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-disconnect"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">ssh_disconnect()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证服务器"><span class="nav-number">1.1.3.</span> <span class="nav-text">验证服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-is-server-known"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">ssh_is_server_known()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-get-pubkey-hash"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">ssh_get_pubkey_hash()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-write-knownhost"><span class="nav-number">1.1.3.3.</span> <span class="nav-text">ssh_write_knownhost()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-get-error-code"><span class="nav-number">1.1.3.4.</span> <span class="nav-text">ssh_get_error_code()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证用户"><span class="nav-number">1.1.4.</span> <span class="nav-text">验证用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#操作"><span class="nav-number">1.1.5.</span> <span class="nav-text">操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-2-用户验证相关"><span class="nav-number">1.2.</span> <span class="nav-text">Chapter 2:用户验证相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#公钥验证方法"><span class="nav-number">1.2.1.</span> <span class="nav-text">公钥验证方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#验证流程"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">验证流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-userauth-publickey-auto"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">ssh_userauth_publickey_auto()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-userauth-publickey"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">ssh_userauth_publickey()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用自己的公钥进行身份验证"><span class="nav-number">1.2.1.4.</span> <span class="nav-text">使用自己的公钥进行身份验证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-pki-import-pubkey-file"><span class="nav-number">1.2.1.5.</span> <span class="nav-text">ssh_pki_import_pubkey_file()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-userauth-try-publickey"><span class="nav-number">1.2.1.6.</span> <span class="nav-text">ssh_userauth_try_publickey()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-pki-import-privkey-file"><span class="nav-number">1.2.1.7.</span> <span class="nav-text">ssh_pki_import_privkey_file()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-key-free"><span class="nav-number">1.2.1.8.</span> <span class="nav-text">ssh_key_free()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#一个示例"><span class="nav-number">1.2.1.9.</span> <span class="nav-text">一个示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#密码验证"><span class="nav-number">1.2.2.</span> <span class="nav-text">密码验证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-userauth-password"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">ssh_userauth_password()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#键盘交互认证方法"><span class="nav-number">1.2.3.</span> <span class="nav-text">键盘交互认证方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-userauth-kbdint"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">ssh_userauth_kbdint()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-userauth-kbdint-getnprompts"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">ssh_userauth_kbdint_getnprompts()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-userauth-kbdint-getname"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">ssh_userauth_kbdint_getname()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-userauth-kbdint-getinstruction"><span class="nav-number">1.2.3.4.</span> <span class="nav-text">ssh_userauth_kbdint_getinstruction()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-userauth-kbdint-getprompt"><span class="nav-number">1.2.3.5.</span> <span class="nav-text">ssh_userauth_kbdint_getprompt()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-user-kbdint-setanswer"><span class="nav-number">1.2.3.6.</span> <span class="nav-text">ssh_user_kbdint_setanswer()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#认证过程"><span class="nav-number">1.2.3.7.</span> <span class="nav-text">认证过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例"><span class="nav-number">1.2.3.8.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用“无验证”模式"><span class="nav-number">1.2.4.</span> <span class="nav-text">使用“无验证”模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-userauth-none"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">ssh_userauth_none()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-1"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取支持的身份验证列表"><span class="nav-number">1.2.5.</span> <span class="nav-text">获取支持的身份验证列表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-userauth-list"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">ssh_userauth_list()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取横幅"><span class="nav-number">1.2.6.</span> <span class="nav-text">获取横幅</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-get-issue-banner"><span class="nav-number">1.2.6.1.</span> <span class="nav-text">ssh_get_issue_banner()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-2"><span class="nav-number">1.2.6.2.</span> <span class="nav-text">示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-3-开启远程终端"><span class="nav-number">1.3.</span> <span class="nav-text">Chapter 3:开启远程终端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#打开和关闭信道"><span class="nav-number">1.3.1.</span> <span class="nav-text">打开和关闭信道</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-new"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">ssh_channel_new()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-open-session"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">ssh_channel_open_session()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-close"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">ssh_channel_close()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-free"><span class="nav-number">1.3.1.4.</span> <span class="nav-text">ssh_channel_free()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-3"><span class="nav-number">1.3.1.5.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#交互会话与非交互会话"><span class="nav-number">1.3.2.</span> <span class="nav-text">交互会话与非交互会话</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-request-pty"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">ssh_channel_request_pty()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-change-pty-size"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">ssh_channel_change_pty_size()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-request-shell"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">ssh_channel_request_shell()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-4"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示远程计算机发送的数据"><span class="nav-number">1.3.3.</span> <span class="nav-text">显示远程计算机发送的数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-read"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">ssh_channel_read()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-5"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#像远程主机发送用户输入"><span class="nav-number">1.3.4.</span> <span class="nav-text">像远程主机发送用户输入</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-write"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">ssh_channel_write()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-6"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-is-open"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">ssh_channel_is_open()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在远程终端使用图形界面"><span class="nav-number">1.3.5.</span> <span class="nav-text">在远程终端使用图形界面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-accept-x11"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">ssh_channel_accept_x11()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-request-x11"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">ssh_channel_request_x11()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-7"><span class="nav-number">1.3.5.3.</span> <span class="nav-text">示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter4-传递远程命令"><span class="nav-number">1.4.</span> <span class="nav-text">Chapter4:传递远程命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#执行远程命令"><span class="nav-number">1.4.1.</span> <span class="nav-text">执行远程命令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-打开一个SSH信道"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">1.打开一个SSH信道</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-执行远程命令"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">2.执行远程命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-获取数据"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">3.获取数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-结束"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">4.结束</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-5-SFTP子系统"><span class="nav-number">1.5.</span> <span class="nav-text">Chapter 5:SFTP子系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#打开和关闭SFTP会话"><span class="nav-number">1.5.1.</span> <span class="nav-text">打开和关闭SFTP会话</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-8"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sftp-new"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">sftp_new()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sftp-init"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">sftp_init()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sftp-free"><span class="nav-number">1.5.1.4.</span> <span class="nav-text">sftp_free()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SFTP错误"><span class="nav-number">1.5.2.</span> <span class="nav-text">SFTP错误</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sftp-get-error"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">sftp_get_error()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#错误编号"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">错误编号</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建一个目录"><span class="nav-number">1.5.3.</span> <span class="nav-text">创建一个目录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-9"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sftp-mkdir"><span class="nav-number">1.5.3.2.</span> <span class="nav-text">sftp_mkdir()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#向远程计算机拷贝文件"><span class="nav-number">1.5.4.</span> <span class="nav-text">向远程计算机拷贝文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-10"><span class="nav-number">1.5.4.1.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sftp-open"><span class="nav-number">1.5.4.2.</span> <span class="nav-text">sftp_open()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sftp-close"><span class="nav-number">1.5.4.3.</span> <span class="nav-text">sftp_close()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从远程计算机读取文件"><span class="nav-number">1.5.5.</span> <span class="nav-text">从远程计算机读取文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#同步读取文件"><span class="nav-number">1.5.5.1.</span> <span class="nav-text">同步读取文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#异步读取数据"><span class="nav-number">1.5.5.2.</span> <span class="nav-text">异步读取数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#列出目录的内容"><span class="nav-number">1.5.6.</span> <span class="nav-text">列出目录的内容</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sftp-opendir"><span class="nav-number">1.5.6.1.</span> <span class="nav-text">sftp_opendir()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sftp-readdir"><span class="nav-number">1.5.6.2.</span> <span class="nav-text">sftp_readdir()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sftp-dir-eof"><span class="nav-number">1.5.6.3.</span> <span class="nav-text">sftp_dir_eof()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sftp-closedir"><span class="nav-number">1.5.6.4.</span> <span class="nav-text">sftp_closedir()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sftp-attributes-free"><span class="nav-number">1.5.6.5.</span> <span class="nav-text">sftp_attributes_free()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-11"><span class="nav-number">1.5.6.6.</span> <span class="nav-text">示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter-6-SCP子系统"><span class="nav-number">1.6.</span> <span class="nav-text">Chapter 6:SCP子系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#开启-关闭SCP会话"><span class="nav-number">1.6.1.</span> <span class="nav-text">开启/关闭SCP会话</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#示例1-递归写入"><span class="nav-number">1.6.1.1.</span> <span class="nav-text">示例1:递归写入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例2-打开连接读取单个文件"><span class="nav-number">1.6.1.2.</span> <span class="nav-text">示例2:打开连接读取单个文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-scp-new"><span class="nav-number">1.6.1.3.</span> <span class="nav-text">ssh_scp_new()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-scp-init"><span class="nav-number">1.6.1.4.</span> <span class="nav-text">ssh_scp_init()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-scp-close"><span class="nav-number">1.6.1.5.</span> <span class="nav-text">ssh_scp_close()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-scp-free"><span class="nav-number">1.6.1.6.</span> <span class="nav-text">ssh_scp_free()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建文件和目录"><span class="nav-number">1.6.2.</span> <span class="nav-text">创建文件和目录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-12"><span class="nav-number">1.6.2.1.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-scp-push-directory"><span class="nav-number">1.6.2.2.</span> <span class="nav-text">ssh_scp_push_directory()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-scp-push-file"><span class="nav-number">1.6.2.3.</span> <span class="nav-text">ssh_scp_push_file()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-scp-write"><span class="nav-number">1.6.2.4.</span> <span class="nav-text">ssh_scp_write()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#读取文件和目录"><span class="nav-number">1.6.3.</span> <span class="nav-text">读取文件和目录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-13"><span class="nav-number">1.6.3.1.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-scp-pull-request"><span class="nav-number">1.6.3.2.</span> <span class="nav-text">ssh_scp_pull_request()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-scp-request-get-size"><span class="nav-number">1.6.3.3.</span> <span class="nav-text">ssh_scp_request_get_size()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-scp-accept-request"><span class="nav-number">1.6.3.4.</span> <span class="nav-text">ssh_scp_accept_request()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-scp-read"><span class="nav-number">1.6.3.5.</span> <span class="nav-text">ssh_scp_read()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-scp-leave-directory"><span class="nav-number">1.6.3.6.</span> <span class="nav-text">ssh_scp_leave_directory()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从远程服务器接收完整的目录数"><span class="nav-number">1.6.4.</span> <span class="nav-text">从远程服务器接收完整的目录数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter7-转发连接-隧道"><span class="nav-number">1.7.</span> <span class="nav-text">Chapter7: 转发连接(隧道)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#直接端口转发"><span class="nav-number">1.7.1.</span> <span class="nav-text">直接端口转发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#流程"><span class="nav-number">1.7.1.1.</span> <span class="nav-text">流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-14"><span class="nav-number">1.7.1.2.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现"><span class="nav-number">1.7.1.3.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-open-forward"><span class="nav-number">1.7.1.4.</span> <span class="nav-text">ssh_channel_open_forward()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-select"><span class="nav-number">1.7.1.5.</span> <span class="nav-text">ssh_select()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反向端口转发"><span class="nav-number">1.7.2.</span> <span class="nav-text">反向端口转发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#流程-1"><span class="nav-number">1.7.2.1.</span> <span class="nav-text">流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例-15"><span class="nav-number">1.7.2.2.</span> <span class="nav-text">示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现-1"><span class="nav-number">1.7.2.3.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-listen-forward"><span class="nav-number">1.7.2.4.</span> <span class="nav-text">ssh_channel_listen_forward()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-channel-accept-forward"><span class="nav-number">1.7.2.5.</span> <span class="nav-text">ssh_channel_accept_forward()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#X11隧道"><span class="nav-number">1.7.3.</span> <span class="nav-text">X11隧道</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#流程-2"><span class="nav-number">1.7.3.1.</span> <span class="nav-text">流程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chapter8-使用libssh的线程"><span class="nav-number">1.8.</span> <span class="nav-text">Chapter8: 使用libssh的线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#线程初始化"><span class="nav-number">1.8.1.</span> <span class="nav-text">线程初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ssh-threads-set-callbacks"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">ssh_threads_set_callbacks()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在libssh中使用libpthread"><span class="nav-number">1.8.2.</span> <span class="nav-text">在libssh中使用libpthread</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Simest</span>

  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.2"></script>



  
  <script src="/js/scrollspy.js?v=7.1.2"></script>
<script src="/js/post-details.js?v=7.1.2"></script>



  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  


  
    

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">



<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: '959bd6f4a9ccefbd3618',
    clientSecret: '54441cf712a8521ff81aa43897433808fb7548d8',
    repo: 'comment',
    owner: 'sim41',
    admin: ['sim41'],
    id: md5(location.pathname),
    
      language: window.navigator.language || window.navigator.userLanguage,
    
    distractionFreeMode: 'true'
  });
  gitalk.render('gitalk-container');
</script>

  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
